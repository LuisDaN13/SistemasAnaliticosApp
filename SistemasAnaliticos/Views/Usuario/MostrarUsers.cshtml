@model IEnumerable<SistemasAnaliticos.ViewModels.UsuarioViewModel>

@{
    Layout = "_Layout";
    var listaUsuarios = Model ?? Enumerable.Empty<UsuarioViewModel>();
    var esVistaRoles = ViewContext.RouteData.Values["controller"]?.ToString() == "Rol";
    var esVistaUsuarios = ViewContext.RouteData.Values["controller"]?.ToString() == "Usuario";
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        :root {
            --primary-color: #012473;
            --secondary-color: #013599;
            --danger-color: #E00319;
            --success-color: #198754;
        }

        .bg-gradient-custom {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .btn-custom-primary {
            background-color: #012473;
            border-color: #012473;
            color: white;
        }

            .btn-custom-primary:hover {
                background-color: #013599;
                border-color: #013599;
                color: white;
            }

        .header-card {
            border-radius: 12px;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            background-color: white;
        }

        /* Estilos para tabs */
        .nav-tabs-custom {
            border-bottom: 2px solid #dee2e6;
            margin-top: 1rem;
        }

            .nav-tabs-custom .nav-link {
                border: none;
                border-bottom: 3px solid transparent;
                color: #6c757d;
                font-weight: 500;
                padding: 12px 20px;
                transition: all 0.3s ease;
                text-decoration: none !important;
                display: inline-block;
            }

                .nav-tabs-custom .nav-link:hover {
                    border-bottom-color: #dee2e6;
                    color: #495057;
                    text-decoration: none;
                }

                .nav-tabs-custom .nav-link.active {
                    color: var(--primary-color);
                    border-bottom-color: var(--primary-color);
                    background-color: transparent;
                    font-weight: 600;
                }

        /* Contenido de tabs */
        .tab-content {
            padding: 20px 0;
            min-height: 400px;
        }

        /* Estilos para la tabla */
        .table-custom {
            width: 100%;
            border-collapse: collapse;
        }

            .table-custom th {
                background-color: #f8f9fa;
                padding: 12px;
                text-align: center;
                border-bottom: 2px solid #dee2e6;
                font-weight: 600;
            }

            .table-custom td {
                padding: 12px;
                text-align: center;
                border-bottom: 1px solid #dee2e6;
                vertical-align: middle;
            }

            .table-custom tr:hover {
                background-color: #f8f9fa;
            }

        /* Estado vacío */
        .empty-state {
            border-radius: 12px;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            background-color: white;
            padding: 3rem;
            text-align: center;
        }

        .empty-state-icon {
            font-size: 4rem;
            color: #dee2e6;
            margin-bottom: 1rem;
        }

        /* Estilos para tabs como enlaces */
        .nav-tabs-custom a.nav-link {
            text-align: center;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gradient-custom min-vh-100">

    <main class="container-xxl px-4 px-sm-6 px-lg-8 py-4">

        <!-- Header -->
        <div class="header-card p-4 mt-4 mb-4 d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h2 fw-bold text-gray-900 mb-0">
                    Gestión de Sistema
                </h1>
                <p class="text-muted mb-0">Administre roles y usuarios del sistema</p>
            </div>

            <button class="btn btn-custom-primary text-white px-4 py-2 fw-medium"
                    data-bs-toggle="modal"
                    data-bs-target="#modalNuevoUsuario">
                <i class="fas fa-user-plus me-2"></i>Crear Nuevo Usuario
            </button>
        </div>


        <!-- Tabs como enlaces de navegación -->
        <div class="card shadow-sm">
            <div class="card-body p-0">
                <!-- Navegación de Tabs -->
                <ul class="nav nav-tabs-custom px-3" id="mainTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <a class="nav-link @(esVistaRoles ? "active" : "")"
                           href="@Url.Action("Index", "Rol")">
                            <i class="fas fa-user-tag me-2"></i>Roles
                        </a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link @(esVistaUsuarios ? "active" : "")"
                           href="@Url.Action("MostrarUsers", "Usuario")">
                            <i class="fas fa-users me-2"></i>Usuarios
                            </span>
                        </a>
                    </li>
                </ul>

                <!-- Contenido para Usuarios -->
                <div class="tab-content p-4" id="mainTabContent">
                    @if (!listaUsuarios.Any())
                    {
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <i class="fas fa-users fa-4x text-muted opacity-25"></i>
                            </div>
                            <h5 class="text-gray-600 fw-medium mb-2">No hay usuarios registrados</h5>
                            <p class="text-gray-500 mb-4">Cree un nuevo usuario para comenzar</p>
                            <button class="btn btn-primary px-4 py-2 fw-medium"
                                    data-bs-toggle="modal"
                                    data-bs-target="#modalNuevoUsuario">
                                <i class="bi bi-plus-circle me-2"></i>Crear Primer Usuario
                            </button>
                        </div>
                    }
                    else
                    {
                        <div class="card border-0 shadow-sm">
                            <div class="card-body p-0">
                                <div class="table-container">
                                    <table id="tablaUsuarios" class="table table-hover mb-0" style="border-collapse: separate; border-spacing: 0;">
                                        <thead class="table-light">
                                            <tr>
                                                <th class="ps-4 py-3 fw-medium text-gray-700 border-bottom" style="width: 25%;">Nombre</th>
                                                <th class="py-3 fw-medium text-gray-700 border-bottom" style="width: 25%;">Usuario/Email</th>
                                                <th class="py-3 fw-medium text-gray-700 border-bottom text-center" style="width: 15%;">Rol</th>
                                                <th class="py-3 fw-medium text-gray-700 border-bottom text-center" style="width: 15%;">Estado</th>
                                                <th class="pe-4 py-3 fw-medium text-gray-700 border-bottom text-end" style="width: 20%;">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var usuario in listaUsuarios)
                                            {
                                                <tr class="position-relative">
                                                    <td class="ps-4 py-3 align-middle border-bottom">
                                                        <div class="d-flex align-items-center">
                                                            <div>
                                                                <h6 class="fw-medium text-gray-900 mb-0">@usuario.NombreCompleto</h6>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td class="py-3 align-middle border-bottom">
                                                        <div class="text-gray-700">@usuario.UserName</div>
                                                    </td>
                                                    <td class="py-3 align-middle border-bottom text-center">
                                                        <span class="badge bg-primary-subtle text-primary border border-primary-subtle px-3 py-2 rounded-pill fw-medium">
                                                            @usuario.RolNombre
                                                        </span>
                                                    </td>
                                                    <td class="py-3 align-middle border-bottom text-center">
                                                        @if (usuario.Estado)
                                                        {
                                                            <span class="badge bg-success-subtle text-success border border-success-subtle px-3 py-2 rounded-pill d-inline-flex align-items-center">
                                                                <span class="dot bg-success me-2"></span>Activo
                                                            </span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge bg-danger-subtle text-danger border border-danger-subtle px-3 py-2 rounded-pill d-inline-flex align-items-center">
                                                                <span class="dot bg-danger me-2"></span>Inactivo
                                                            </span>
                                                        }
                                                    </td>
                                                    <td class="pe-4 py-3 align-middle border-bottom text-end">
                                                        <div class="d-flex justify-content-end gap-2">
                                                            <button class="btn btn-sm btn-outline-warning rounded-circle"
                                                                    onclick="abrirModalCambiarRol('@usuario.Id', '@usuario.NombreCompleto', '@usuario.RolNombre')"
                                                                    title="Cambiar rol"
                                                                    style="width: 36px; height: 36px;">
                                                                <i class="fas fa-exchange-alt"></i>
                                                            </button>
                                                            <button class="btn btn-sm btn-outline-danger rounded-circle"
                                                                    onclick="abrirModalInactivar('@usuario.Id', '@usuario.NombreCompleto', @usuario.Estado.ToString().ToLower())"
                                                                    title="Cambiar estado"
                                                                    style="width: 36px; height: 36px;">
                                                                <i class="fa-solid fa-ban"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
            <style>
                /* Estilos minimalistas para la tabla */
                .table-container {
                    border-radius: 12px;
                    overflow: hidden;
                }

                .table {
                    --bs-table-bg: transparent;
                    --bs-table-striped-bg: rgba(0, 0, 0, 0.02);
                    --bs-table-hover-bg: rgba(0, 0, 0, 0.03);
                }

                .table-light {
                    --bs-table-bg: #f8fafc;
                    --bs-table-border-color: #e2e8f0;
                }

                .border-bottom {
                    border-bottom: 1px solid #e2e8f0 !important;
                }

                .avatar-sm {
                    width: 36px;
                    height: 36px;
                }

                .avatar-title {
                    width: 100%;
                    height: 100%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 14px;
                }

                .dot {
                    width: 8px;
                    height: 8px;
                    border-radius: 50%;
                    display: inline-block;
                }

                .btn-outline-primary, .btn-outline-warning {
                    border-width: 1px;
                    transition: all 0.2s ease;
                }

                    .btn-outline-primary:hover {
                        background-color: var(--primary-color);
                        border-color: var(--primary-color);
                        color: white;
                    }

                    .btn-outline-warning:hover {
                        background-color: var(--warning);
                        border-color: var(--warning);
                        color: white;
                    }

                /* Estilos para DataTable personalizado */
                .dataTables_wrapper {
                    padding: 0;
                }

                .dataTables_filter {
                    padding: 1rem 1.5rem;
                    background: #f8fafc;
                    border-bottom: 1px solid #e2e8f0;
                }

                    .dataTables_filter input {
                        border: 1px solid #e2e8f0;
                        border-radius: 8px;
                        padding: 8px 12px;
                        width: 250px !important;
                    }

                        .dataTables_filter input:focus {
                            border-color: var(--primary-color);
                            box-shadow: 0 0 0 3px rgba(1, 36, 115, 0.1);
                        }

                .dataTables_paginate {
                    padding: 1rem 1.5rem;
                    background: #f8fafc;
                    border-top: 1px solid #e2e8f0;
                }

                    .dataTables_paginate .paginate_button {
                        border: 1px solid #e2e8f0 !important;
                        border-radius: 8px !important;
                        margin: 0 4px;
                        padding: 6px 12px !important;
                        color: #64748b !important;
                        background: white !important;
                        transition: all 0.2s ease;
                    }

                        .dataTables_paginate .paginate_button:hover {
                            background: #f1f5f9 !important;
                            border-color: #cbd5e1 !important;
                            color: #475569 !important;
                        }

                        .dataTables_paginate .paginate_button.current {
                            background: var(--primary-color) !important;
                            border-color: var(--primary-color) !important;
                            color: white !important;
                        }

                .empty-state {
                    padding: 4rem 2rem;
                    text-align: center;
                    background: white;
                    border-radius: 16px;
                    border: 2px dashed #e2e8f0;
                }

                .empty-state-icon {
                    margin-bottom: 1.5rem;
                }

                /* Colores personalizados */
                .bg-primary-subtle {
                    background-color: rgba(1, 36, 115, 0.1);
                }

                .text-primary {
                    color: var(--primary-color) !important;
                }

                .bg-success-subtle {
                    background-color: rgba(25, 135, 84, 0.1);
                }

                .bg-danger-subtle {
                    background-color: rgba(224, 3, 25, 0.1);
                }

                .border-primary-subtle {
                    border-color: rgba(1, 36, 115, 0.2) !important;
                }

                .border-success-subtle {
                    border-color: rgba(25, 135, 84, 0.2) !important;
                }

                .border-danger-subtle {
                    border-color: rgba(224, 3, 25, 0.2) !important;
                }

                /* Responsive */
                @@media (max-width: 768px) {
                    .table-responsive

                {
                    margin: 0 -1rem;
                    padding: 0 1rem;
                }

                .dataTables_filter input {
                    width: 200px !important;
                }

                }
            </style>
        </div>
    </main>


    <!-- Modal para Cambiar Estado (Inactivar) -->
    <div class="modal fade" id="modalInactivarUsuario" tabindex="-1" aria-labelledby="modalInactivarUsuarioLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="modalInactivarUsuarioLabel">Cambiar Estado del Usuario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4 text-center">
                    <div class="mb-3">
                        <i class="fas fa-user-slash fa-3x text-warning mb-3"></i>
                        <h6 class="fw-bold">¿Está seguro que desea cambiar el estado del usuario?</h6>
                        <p class="text-muted mb-0" id="usuarioInfoInactivar"></p>
                    </div>
                </div>
                <form id="formInactivarUsuario" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="usuarioIdInactivar" name="id" />
                    <div class="modal-footer d-flex justify-content-around">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-exchange-alt me-2"></i>Cambiar Estado
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {

            const modalElement = document.getElementById('modalInactivarUsuario');
            const modal = new bootstrap.Modal(modalElement);
            const form = document.getElementById('formInactivarUsuario');

            // FUNCIÓN GLOBAL → abre el modal
            window.abrirModalInactivar = function (usuarioId, nombreCompleto, estadoActual) {

                document.getElementById('usuarioInfoInactivar').textContent = nombreCompleto;
                document.getElementById('usuarioIdInactivar').value = usuarioId;

                modal.show();
            };

            // SUBMIT del formulario
            form.addEventListener('submit', async function (e) {
                e.preventDefault();

                const usuarioId = document.getElementById('usuarioIdInactivar').value;
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

                try {
                    const response = await fetch(`/Usuario/InactivarUs/${usuarioId}`, {
                        method: 'POST',
                        headers: {
                            'RequestVerificationToken': token
                        }
                    });

                    const result = await response.json();

                    modal.hide();

                    if (result.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Éxito',
                            text: 'El estado del usuario fue cambiado correctamente',
                            timer: 6000
                        }).then(() => {
                            result.redirectUrl ?
                                window.location.href = result.redirectUrl :
                                location.reload();
                        });

                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: result.message || 'Error desconocido',
                            timer: 6000
                        });
                    }

                } catch (error) {
                    modal.hide();
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Error de red o del servidor',
                        timer: 6000
                    });
                }
            });
        });
    </script>

    <!-- Modal para Cambiar Rol -->
    <div class="modal fade" id="modalCambiarRol" tabindex="-1" aria-labelledby="modalCambiarRolLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" style="background-color: var(--primary-color);">
                    <h5 class="modal-title text-white" id="modalCambiarRolLabel">Cambiar Rol del Usuario</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="text-center mb-4">
                        <i class="fas fa-user-tag fa-3x text-primary mb-3"></i>
                        <h6 class="fw-bold mb-1">Cambiar rol asignado</h6>
                        <p class="text-muted mb-0" id="usuarioInfoCambiarRol"></p>
                        <p class="text-muted">Rol actual: <span id="rolActualUsuario" class="badge bg-info"></span></p>
                    </div>

                    <div class="mb-3">
                        <label for="nuevoRolId" class="form-label fw-medium">Seleccionar nuevo rol:</label>
                        <select class="form-select" id="nuevoRolId" name="rolId" required>
                            <option value="">-- Seleccione un rol --</option>
                            @if (ViewBag.RolesDisponibles != null)
                            {
                                foreach (var rol in ViewBag.RolesDisponibles)
                                {
                                    <option value="@rol.Id">@rol.Name</option>
                                }
                            }
                        </select>
                        <div class="form-text">Seleccione el nuevo rol para asignar al usuario.</div>
                    </div>
                </div>
                <form id="formCambiarRol" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="usuarioIdCambiarRol" name="id" />
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-custom-primary text-white">
                            <i class="fas fa-save me-2"></i>Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>
        function abrirModalCambiarRol(usuarioId, nombreCompleto, rolActual) {

            const modalEl = document.getElementById('modalCambiarRol');
            const modal = new bootstrap.Modal(modalEl);
            const form = document.getElementById('formCambiarRol');
            const select = document.getElementById('nuevoRolId');

            // Info del usuario
            document.getElementById('usuarioInfoCambiarRol').textContent = nombreCompleto;
            document.getElementById('usuarioIdCambiarRol').value = usuarioId;

            // Rol actual
            const rolActualElement = document.getElementById('rolActualUsuario');
            rolActualElement.textContent = rolActual;
            rolActualElement.className = 'badge bg-info text-white';

            // Cargar roles
            select.innerHTML = '<option value="">Cargando roles...</option>';

            fetch('@Url.Action("GetRoles", "Usuario")')
                .then(response => {
                    if (!response.ok) throw new Error('Error al obtener roles');
                    return response.json();
                })
                .then(data => {
                    select.innerHTML = '<option value="">-- Seleccione un rol --</option>';

                    if (data && data.success && Array.isArray(data.roles)) {
                        data.roles.forEach(rol => {
                            if (rol.nombre.toLowerCase() !== rolActual.toLowerCase()) {
                                const option = document.createElement('option');
                                option.value = rol.id;
                                option.textContent = rol.nombre;
                                select.appendChild(option);
                            }
                        });

                        if (select.options.length === 1) {
                            select.innerHTML = '<option value="">No hay otros roles disponibles</option>';
                        }
                    } else {
                        select.innerHTML = '<option value="">Formato inválido</option>';
                    }
                })
                .catch(() => {
                    select.innerHTML = '<option value="">Error al cargar roles</option>';
                });

            // Limpiar submit previo
            form.onsubmit = null;

            form.onsubmit = async function (e) {
                e.preventDefault();

                if (!select.value) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Rol requerido',
                        text: 'Debe seleccionar un nuevo rol'
                    });
                    return;
                }

                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

                try {
                    const response = await fetch(`/Usuario/CambiarRol/${usuarioId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': token
                        },
                        body: JSON.stringify({
                            rolId: select.value
                        })
                    });

                    const result = await response.json();
                    modal.hide();

                    if (result.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Éxito',
                            text: result.message || 'Rol cambiado correctamente',
                            timer: 3000
                        }).then(() => location.reload());
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: result.message || 'Error al cambiar el rol'
                        });
                    }

                } catch (error) {
                    modal.hide();
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Error de red o del servidor'
                    });
                }
            };

            // 🔥 AHORA SÍ se abre el modal
            modal.show();
        }
    </script>

    <!-- Modal para Crear Usuario Básico -->
    <div class="modal fade" id="modalNuevoUsuario" tabindex="-1" aria-labelledby="modalNuevoUsuarioLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background-color: var(--primary-color);">
                    <h5 class="modal-title text-white" id="modalNuevoUsuarioLabel">Crear Nuevo Usuario</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <form id="formCrearUsuario" method="post" action="@Url.Action("CrearUsuario", "Usuario")" novalidate>
                    @Html.AntiForgeryToken()
                    <div class="modal-body p-4">
                        <div class="text-center mb-4">
                            <i class="fas fa-user-plus fa-3x text-primary mb-3"></i>
                            <h6 class="fw-bold mb-1">Complete la información del nuevo usuario</h6>
                            <p class="text-muted mb-3">Los campos marcados con <span class="text-danger">*</span> son obligatorios</p>
                        </div>

                        <div class="row g-3">
                            <!-- Primera fila: Nombres -->
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="primerNombre" class="form-label fw-medium">
                                        Primer Nombre <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control campo-validacion" id="primerNombre" name="primerNombre"
                                           maxlength="50" placeholder="Ingrese el primer nombre">
                                    <div class="mensaje-error" id="errorPrimerNombre" style="display: none; color: #E00319; font-size: 0.875rem; margin-top: 0.25rem;">
                                        El primer nombre es obligatorio
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="segundoNombre" class="form-label fw-medium">Segundo Nombre</label>
                                    <input type="text" class="form-control" id="segundoNombre" name="segundoNombre"
                                           maxlength="50" placeholder="Opcional">
                                </div>
                            </div>

                            <!-- Segunda fila: Apellidos -->
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="primerApellido" class="form-label fw-medium">
                                        Primer Apellido <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control campo-validacion" id="primerApellido" name="primerApellido"
                                           maxlength="50" placeholder="Ingrese el primer apellido">
                                    <div class="mensaje-error" id="errorPrimerApellido" style="display: none; color: #E00319; font-size: 0.875rem; margin-top: 0.25rem;">
                                        El primer apellido es obligatorio
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="segundoApellido" class="form-label fw-medium">Segundo Apellido</label>
                                    <input type="text" class="form-control" id="segundoApellido" name="segundoApellido"
                                           maxlength="50" placeholder="Opcional">
                                </div>
                            </div>

                            <!-- Tercera fila: Correo y Contraseña -->
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="correo" class="form-label fw-medium">
                                        Correo Electrónico Empresarial <span class="text-danger">*</span>
                                    </label>
                                    <input type="email" class="form-control campo-validacion" id="correo" name="correo"
                                           maxlength="100" placeholder="usuario@ejemplo.com">
                                    <div class="form-text">Este será el nombre de usuario</div>
                                    <div class="mensaje-error" id="errorCorreo" style="display: none; color: #E00319; font-size: 0.875rem; margin-top: 0.25rem;">
                                        Ingrese un correo electrónico válido
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="contrasena" class="form-label fw-medium">
                                        Contraseña <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <input type="password" class="form-control campo-validacion" id="contrasena" name="contrasena"
                                               placeholder="Mínimo 8 caracteres">
                                        <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">Debe tener al menos 8 caracteres</div>
                                    <div class="mensaje-error" id="errorContrasena" style="display: none; color: #E00319; font-size: 0.875rem; margin-top: 0.25rem;">
                                        La contraseña debe tener al menos 8 caracteres
                                    </div>
                                </div>
                            </div>

                            <!-- Cuarta fila: Rol -->
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="rolId" class="form-label fw-medium">
                                        Rol del Usuario <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select campo-validacion" id="rolId" name="rolId">
                                        <option value="">Cargando roles...</option>
                                    </select>
                                    <div class="form-text">Seleccione el rol que tendrá el usuario en el sistema</div>
                                    <div class="mensaje-error" id="errorRolId" style="display: none; color: #E00319; font-size: 0.875rem; margin-top: 0.25rem;">
                                        Debe seleccionar un rol
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-custom-primary text-white" id="btnCrearUsuario">
                            <i class="fas fa-save me-2"></i>Crear Usuario
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Elementos del DOM
            const form = document.getElementById('formCrearUsuario');
            const btnCrearUsuario = document.getElementById('btnCrearUsuario');
            const togglePasswordBtn = document.getElementById('togglePassword');
            const passwordInput = document.getElementById('contrasena');
            const rolSelect = document.getElementById('rolId');
            const modalElement = document.getElementById('modalNuevoUsuario');
        
            // Variables para el modal de Bootstrap
            let nuevoUsuarioModal = null;
            if (modalElement) {
                nuevoUsuarioModal = new bootstrap.Modal(modalElement);
            }

            // Toggle para mostrar/ocultar contraseña
            if (togglePasswordBtn && passwordInput) {
                togglePasswordBtn.addEventListener('click', function () {
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);
                
                    const icon = this.querySelector('i');
                    if (icon) {
                        icon.classList.toggle('fa-eye');
                        icon.classList.toggle('fa-eye-slash');
                    }
                });
            }

            // Cargar roles cuando se abre el modal
            if (modalElement) {
                modalElement.addEventListener('show.bs.modal', function () {
                    cargarRoles();
                    limpiarFormulario();
                });
            }

            // Función para cargar roles desde el servidor
            function cargarRoles() {
                if (!rolSelect) return;
            
                // Mostrar estado de carga
                rolSelect.innerHTML = '<option value="">Cargando roles...</option>';
                rolSelect.disabled = true;
            
                fetch('@Url.Action("GetRoles", "Usuario")')
                    .then(response => {
                        if (!response.ok) throw new Error('Error al obtener roles');
                        return response.json();
                    })
                    .then(data => {
                        rolSelect.innerHTML = '<option value="">-- Seleccione un rol --</option>';
                    
                        if (data && data.success && Array.isArray(data.roles)) {
                            if (data.roles.length === 0) {
                                rolSelect.innerHTML = '<option value="">No hay roles disponibles</option>';
                            } else {
                                data.roles.forEach(rol => {
                                    const option = document.createElement('option');
                                    option.value = rol.id;
                                    option.textContent = rol.nombre;
                                    rolSelect.appendChild(option);
                                });
                            }
                        } else {
                            rolSelect.innerHTML = '<option value="">Error al cargar roles</option>';
                        }
                    
                        rolSelect.disabled = false;
                    })
                    .catch((error) => {
                        console.error('Error cargando roles:', error);
                        rolSelect.innerHTML = '<option value="">Error al conectar con el servidor</option>';
                        rolSelect.disabled = false;
                    });
            }

            // Prevenir el envío nativo del formulario
            if (form) {
                form.addEventListener('submit', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                
                    // Validar formulario
                    if (validarFormulario()) {
                        enviarFormulario();
                    }
                });
            }

            // Validación en tiempo real para campos obligatorios
            const camposValidacion = ['primerNombre', 'primerApellido', 'correo', 'contrasena', 'rolId'];
        
            camposValidacion.forEach(campoId => {
                const campo = document.getElementById(campoId);
                if (campo) {
                    // Validar al perder foco
                    campo.addEventListener('blur', function() {
                        validarCampo(this);
                    });
                
                    // Limpiar error al empezar a escribir
                    campo.addEventListener('input', function() {
                        limpiarError(this.id);
                    });
                }
            });

            // Para el select de roles, validar al cambiar
            if (rolSelect) {
                rolSelect.addEventListener('change', function() {
                    limpiarError('rolId');
                    validarCampo(this);
                });
            }

            // Validación específica para correo
            const correoInput = document.getElementById('correo');
            if (correoInput) {
                correoInput.addEventListener('blur', function() {
                    if (this.value.trim()) {
                        validarEmail(this);
                    }
                });
            }

            // Validación específica para contraseña
            if (passwordInput) {
                passwordInput.addEventListener('blur', function() {
                    if (this.value) {
                        validarContrasena(this);
                    }
                });
            }

            // Función para validar un campo individual
            function validarCampo(campo) {
                const valor = campo.value.trim();
                const campoId = campo.id;
            
                // Limpiar error previo
                limpiarError(campoId);
            
                // Validaciones específicas por campo
                switch(campoId) {
                    case 'primerNombre':
                    case 'primerApellido':
                        if (!valor) {
                            mostrarError(campoId, campoId === 'primerNombre' ? 
                                'El primer nombre es obligatorio' : 
                                'El primer apellido es obligatorio');
                            return false;
                        }
                        return true;
                    
                    case 'correo':
                        return validarEmail(campo);
                    
                    case 'contrasena':
                        return validarContrasena(campo);
                    
                    case 'rolId':
                        if (!valor) {
                            mostrarError(campoId, 'Debe seleccionar un rol');
                            return false;
                        }
                        return true;
                    
                    default:
                        return true;
                }
            }

            // Función para validar email
            function validarEmail(input) {
                const email = input.value.trim();
                const emailRegex = /^[^\s@@]+@@[^\s@@]+\.[^\s@@1]+$/;
            
                limpiarError('correo');
            
                if (!email) {
                    mostrarError('correo', 'El correo electrónico es obligatorio');
                    return false;
                }
            
                if (!emailRegex.test(email)) {
                    mostrarError('correo', 'Ingrese un correo electrónico válido');
                    return false;
                }
            
                return true;
            }

            // Función para validar contraseña
            function validarContrasena(input) {
                const contrasena = input.value;
            
                limpiarError('contrasena');
            
                if (!contrasena) {
                    mostrarError('contrasena', 'La contraseña es obligatoria');
                    return false;
                }
            
                if (contrasena.length < 8) {
                    mostrarError('contrasena', 'La contraseña debe tener al menos 8 caracteres');
                    return false;
                }
            
                return true;
            }

            // Función para validar todo el formulario
            function validarFormulario() {
                let esValido = true;
            
                // Validar cada campo obligatorio
                camposValidacion.forEach(campoId => {
                    const campo = document.getElementById(campoId);
                    if (campo && !validarCampo(campo)) {
                        esValido = false;
                    }
                });
            
                return esValido;
            }

            // Función para mostrar error en un campo
            function mostrarError(campoId, mensaje) {
                // Resaltar el campo
                const campo = document.getElementById(campoId);
                if (campo) {
                    campo.style.borderColor = '#E00319';
                    campo.style.boxShadow = '0 0 0 0.25rem rgba(224, 3, 25, 0.25)';
                }
            
                // Mostrar mensaje de error
                const errorElement = document.getElementById(`error${campoId.charAt(0).toUpperCase() + campoId.slice(1)}`);
                if (errorElement) {
                    errorElement.textContent = mensaje;
                    errorElement.style.display = 'block';
                }
            }

            // Función para limpiar error de un campo
            function limpiarError(campoId) {
                // Restaurar estilo del campo
                const campo = document.getElementById(campoId);
                if (campo) {
                    campo.style.borderColor = '';
                    campo.style.boxShadow = '';
                }
            
                // Ocultar mensaje de error
                const errorElement = document.getElementById(`error${campoId.charAt(0).toUpperCase() + campoId.slice(1)}`);
                if (errorElement) {
                    errorElement.style.display = 'none';
                }
            }

            // Función para enviar el formulario
            async function enviarFormulario() {
                // Deshabilitar el botón para evitar múltiples clics
                btnCrearUsuario.disabled = true;
                btnCrearUsuario.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creando...';
            
                try {
                    // Obtener el token anti-CSRF
                    const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
                
                    // Crear FormData
                    const formData = new FormData(form);
                
                    // Enviar datos al servidor
                    const response = await fetch(form.action, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'RequestVerificationToken': token
                        },
                        body: formData
                    });
                
                    // Procesar respuesta
                    await procesarRespuesta(response);
                
                } catch (error) {
                    console.error('Error en la solicitud:', error);
                    mostrarErrorSweetAlert('Error de conexión. Verifique su conexión a internet.');
                    restaurarBoton();
                }
            }

            // Función para procesar la respuesta del servidor
            async function procesarRespuesta(response) {
                try {
                    const result = await response.json();
                
                    if (result.success) {
                        // Cerrar modal
                        if (nuevoUsuarioModal) {
                            nuevoUsuarioModal.hide();
                        }
                    
                        // Mostrar mensaje de éxito
                        Swal.fire({
                            icon: 'success',
                            title: '¡Usuario creado!',
                            text: result.message || 'El usuario ha sido creado exitosamente',
                            confirmButtonColor: '#012473',
                            timer: 3000,
                            timerProgressBar: true,
                            showConfirmButton: true
                        }).then(() => {
                            // Recargar la página para mostrar el nuevo usuario
                            window.location.reload();
                        });
                    } else {
                        // Mostrar error del servidor
                        mostrarErrorSweetAlert(result.message || 'Error al crear el usuario');
                        restaurarBoton();
                    }
                } catch (error) {
                    console.error('Error procesando respuesta:', error);
                
                    // Si no es JSON, puede ser un redirect o error HTML
                    if (response.redirected) {
                        window.location.href = response.url;
                    } else {
                        mostrarErrorSweetAlert('Error inesperado en el servidor');
                        restaurarBoton();
                    }
                }
            }

            // Función para mostrar errores con SweetAlert
            function mostrarErrorSweetAlert(message) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: message,
                    confirmButtonColor: '#E00319',
                    confirmButtonText: 'Entendido'
                });
            }

            // Función para restaurar el botón
            function restaurarBoton() {
                btnCrearUsuario.disabled = false;
                btnCrearUsuario.innerHTML = '<i class="fas fa-save me-2"></i>Crear Usuario';
            }

            // Limpiar formulario cuando se cierra el modal
            if (modalElement) {
                modalElement.addEventListener('hidden.bs.modal', function () {
                    limpiarFormulario();
                });
            }

            // Función para limpiar el formulario
            function limpiarFormulario() {
                if (form) {
                    form.reset();
                
                    // Limpiar todos los errores
                    camposValidacion.forEach(campoId => {
                        limpiarError(campoId);
                    });
                
                    // Restablecer el select de roles
                    if (rolSelect) {
                        rolSelect.innerHTML = '<option value="">Cargando roles...</option>';
                        rolSelect.disabled = true;
                    }
                }
            
                // Restaurar tipo de contraseña
                if (passwordInput) {
                    passwordInput.setAttribute('type', 'password');
                }
            
                // Restaurar icono de ojo
                if (togglePasswordBtn) {
                    const icon = togglePasswordBtn.querySelector('i');
                    if (icon) {
                        icon.classList.remove('fa-eye-slash');
                        icon.classList.add('fa-eye');
                    }
                }
            
                // Restaurar botón
                restaurarBoton();
            }
        });
    </script>
    <style>
        /* Estilos para campos con error */
        .campo-validacion.error {
            border-color: #E00319 !important;
            box-shadow: 0 0 0 0.25rem rgba(224, 3, 25, 0.25) !important;
        }
    
        /* Estilo normal para campos al enfocar */
        .form-control:focus,
        .form-select:focus {
            border-color: #012473;
            box-shadow: 0 0 0 0.25rem rgba(1, 36, 115, 0.25);
        }
    
        /* Estilo para el botón de toggle password */
        #togglePassword {
            border-color: #dee2e6;
            transition: all 0.2s ease;
        }
    
        #togglePassword:hover {
            background-color: #f8f9fa;
            border-color: #012473;
        }
    
        /* Mejoras visuales para los campos */
        .form-control, .form-select {
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
    
        /* Estilo para mensajes de error */
        .mensaje-error {
            color: #E00319;
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: none;
        }
    
        /* Estilo para select deshabilitado mientras carga */
        .form-select:disabled {
            background-color: #f8f9fa;
            opacity: 0.7;
            cursor: not-allowed;
        }
    </style>

    @section Scripts {
        <!-- DATA TABLE -->
        <script>
            $(document).ready(function () {
                $('#tablaUsuarios').DataTable({
                    responsive: true,
                    pageLength: 10,
                    lengthChange: false,
                    ordering: true,
                    info: false,
                    language: {
                        search: "",
                        searchPlaceholder: "Buscar usuarios...",
                        zeroRecords: "No se encontraron usuarios",
                        paginate: {
                            next: '<i class="fas fa-chevron-right"></i>',
                            previous: '<i class="fas fa-chevron-left"></i>'
                        }
                    },
                    // Configuración del layout
                    dom: '<"row mb-3"<"col-md-12"f>>rt<"row mt-3"<"col-md-12"p>>',
                    initComplete: function () {
                        // Estilizar el input de búsqueda
                        $('.dataTables_filter input')
                            .addClass('form-control')
                            .attr('style', 'width: 100%; max-width: 300px;');
                    },
                    columnDefs: [
                        { orderable: false, targets: 4 },
                        { className: "align-middle", targets: "_all" }
                    ],
                    drawCallback: function () {
                        // Estilizar botones de paginación
                        $('.paginate_button')
                            .addClass('btn btn-sm btn-outline-secondary mx-1')
                            .css({
                                'border-radius': '6px',
                                'padding': '4px 12px'
                            });

                        $('.paginate_button.current')
                            .removeClass('btn-outline-secondary')
                    }
                });
            });
        </script>

        <!-- RESPUESTAS DE TEMP DATA -->
        <script>
            // Mostrar mensajes de TempData
            @if (TempData["SuccessMessage"] != null)
            {
                        <text>
                            Swal.fire({
                                icon: 'success',
                                title: 'Éxito',
                                text: '@Html.Raw(TempData["SuccessMessage"])',
                                confirmButtonText: 'Aceptar',
                                timer: 3000
                            });
                        </text>
            }

            @if (TempData["ErrorMessage"] != null)
            {
                        <text>
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: '@Html.Raw(TempData["ErrorMessage"])',
                                confirmButtonText: 'Aceptar'
                            });
                        </text>
            }
        </script>
    }
</body>
</html>