@model SistemasAnaliticos.ViewModels.PaginacionConstanciasViewModel

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        .bg-gradient-custom {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        :root {
            --primary-color: #012473;
            --secondary-color: #013599;
            --danger-color: #E00319;
            --success-color: #198754;
        }

        .header-card {
            border-radius: 12px;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            background-color: white;
        }

        .colorcito {
            background-color: #e3f2fd !important;
            color: #0d6efd !important;
            border: 1px solid #bbdefb !important;
        }
    </style>
    <style>
        .category-header {
            cursor: pointer;
            transition: background-color 0.3s;
        }

            .category-header:hover {
                background-color: #f8f9fa !important;
            }

        .border-left-accent1 {
            border-left-color: #0d6efd;
            border-left-width: 4px !important;
            border-left-style: solid;
        }

        .border-left-accent2 {
            border-left-color: #146c43;
            border-left-width: 4px !important;
            border-left-style: solid;
        }

        .badge-status {
            font-size: 0.75rem;
            padding: 0.375rem 0.75rem;
        }

        .action-btn {
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s;
        }

        .chevron-icon {
            color: #0d6efd;
            transition: transform 0.3s;
        }

        .chevron-rotated {
            transform: rotate(180deg);
        }
    </style>
    <style>
        .custom-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }

        #constanciasContainer {
            transition: opacity 0.3s ease;
            opacity: 1;
        }

        .constancia-card {
            transition: all 0.3s ease;
            border: 1px solid #dee2e6;
        }

            .constancia-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
                border-color: var(--primary-color);
            }

        .no-results {
            transition: opacity 0.3s ease;
        }

        .card {
            animation: fadeInUp 0.5s ease;
        }

        @@keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .filter-section {
            position: sticky;
            top: 5rem;
        }

        .no-results {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .drop-zone {
            border: 2px dashed #0d6efd;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            color: #0d6efd;
            width: 100%;
        }
    </style>
</head>
<body class="bg-gradient-custom min-vh-100">

    <!-- Main Content -->
    <main class="container-xxl px-4 px-sm-6 px-lg-8 py-4 pb-0">

        <!-- Titulo de Constancias -->
        <div class="header-card p-4 mt-4 mb-4 d-flex justify-content-between">
            <h1 class="h2 fw-bold text-gray-900 mb-0">Ver Todas las Constancias</h1>
            <div>
                @if(!User.IsInRole("Empleado Normal") && !User.IsInRole("Jefatura"))
                {
                    <button type="button" class="btn btn-primary" onclick="abrirModalMasivo()">Cambiar estado</button>
                }
                <button class="btn btn-success" id="exportExcelBtnC">
                    <i class="bi bi-file-earmark-excel"></i>
                </button>
                <button class="btn btn-danger" id="exportPdfBtnC">
                    <i class="bi bi-file-earmark-pdf"></i>
                </button>
            </div>

        </div>

        <!-- constanciaas Types Grid -->
        <div class="container my-4">
            <div class="row">
                <!-- FILTROS PARA CARDS -->
                <div class="col-lg-3">
                    <div class="card filter-section">
                        <div class="card-body">
                            <h2 class="h5 card-title fw-bold text-dark mb-4">Filtrar por</h2>

                            <!-- CHECKS DE TIPOS DE PERMISOS -->
                            <div class="mb-4 pb-3 border-bottom">
                                <button class="btn w-100 d-flex justify-content-between align-items-center p-0 text-dark fw-semibold" type="button" data-bs-toggle="collapse" data-bs-target="#typeFilter" aria-expanded="true" aria-controls="typeFilter">
                                    Tipo de Constancia
                                    <i class="bi bi-chevron-down"></i>
                                </button>
                                <div class="collapse show mt-3" id="typeFilter">
                                    <div class="d-flex flex-column gap-2">
                                        <div class="form-check">
                                            <input class="form-check-input filter-type" type="checkbox" value="Laboral" id="type-laboral">
                                            <label class="form-check-label d-flex justify-content-between w-100" for="type-laboral">
                                                <span>Laboral</span>
                                                <span class="text-muted" id="count-laboral">(0)</span>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input filter-type" type="checkbox" value="Salarial" id="type-salarial">
                                            <label class="form-check-label d-flex justify-content-between w-100" for="type-salarial">
                                                <span>Salarial</span>
                                                <span class="text-muted" id="count-salarial">(0)</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- CHECKS DE ESTADOS DE PERMISOS -->
                            <div class="mb-3 pb-1 border-bottom">
                                <button class="btn w-100 d-flex justify-content-between align-items-center p-0 text-dark fw-semibold" type="button" data-bs-toggle="collapse" data-bs-target="#statusFilter" aria-expanded="false" aria-controls="statusFilter">
                                    Estado
                                    <i class="bi bi-chevron-down"></i>
                                </button>
                                <div class="collapse mt-3" id="statusFilter">
                                    <div class="d-flex flex-column gap-2">
                                        <div class="form-check">
                                            <input class="form-check-input filter-status" type="checkbox" value="Creada" id="status-creada">
                                            <label class="form-check-label d-flex justify-content-between w-100" for="status-creada">
                                                <span>Creada</span>
                                                <span class="text-muted" id="count-creada">(0)</span>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input filter-status" type="checkbox" value="Aprobada" id="status-approved">
                                            <label class="form-check-label d-flex justify-content-between w-100" for="status-approved">
                                                <span>Aprobada</span>
                                                <span class="text-muted" id="count-approved">(0)</span>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input filter-status" type="checkbox" value="Pendiente" id="status-pending">
                                            <label class="form-check-label d-flex justify-content-between w-100" for="status-pending">
                                                <span>Pendiente</span>
                                                <span class="text-muted" id="count-pending">(0)</span>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input filter-status" type="checkbox" value="Rechazada" id="status-rejected">
                                            <label class="form-check-label d-flex justify-content-between w-100" for="status-rejected">
                                                <span>Rechazada</span>
                                                <span class="text-muted" id="count-rejected">(0)</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- DROPDOWN DE DEPARTAMENTOS -->
                            <div class="mb-3 pb-1 border-bottom">
                                <button class="btn w-100 d-flex justify-content-between align-items-center p-0 text-dark fw-semibold dropdown-toggle"
                                        type="button" id="dropdownDepartamento" data-bs-toggle="dropdown" aria-expanded="false">
                                    Departamentos
                                </button>

                                <ul class="dropdown-menu w-100 px-3" aria-labelledby="dropdownDepartamento">

                                    <li class="form-check my-2">
                                        <input class="form-check-input filter-departamento" type="checkbox" value="Bodega" id="dropdown-dp-bo">
                                        <label class="form-check-label d-flex justify-content-between w-100" for="dropdown-dp-bo">
                                            <span>Bodega</span>
                                            <span class="text-muted" id="dropdown-count-bo">(0)</span>
                                        </label>
                                    </li>

                                    <li class="form-check my-2">
                                        <input class="form-check-input filter-departamento" type="checkbox" value="Financiero Contable" id="dropdown-dp-fc">
                                        <label class="form-check-label d-flex justify-content-between w-100" for="dropdown-dp-fc">
                                            <span>Financiero Contable</span>
                                            <span class="text-muted" id="dropdown-count-fc">(0)</span>
                                        </label>
                                    </li>

                                    <li class="form-check my-2">
                                        <input class="form-check-input filter-departamento" type="checkbox" value="Gerencia" id="dropdown-dp-g">
                                        <label class="form-check-label d-flex justify-content-between w-100" for="dropdown-dp-g">
                                            <span>Gerencia</span>
                                            <span class="text-muted" id="dropdown-count-g">(0)</span>
                                        </label>
                                    </li>

                                    <li class="form-check my-2">
                                        <input class="form-check-input filter-departamento" type="checkbox" value="Ingenieria" id="dropdown-dp-i">
                                        <label class="form-check-label d-flex justify-content-between w-100" for="dropdown-dp-i">
                                            <span>Ingeniería</span>
                                            <span class="text-muted" id="dropdown-count-i">(0)</span>
                                        </label>
                                    </li>

                                    <li class="form-check my-2">
                                        <input class="form-check-input filter-departamento" type="checkbox" value="Jefatura" id="dropdown-dp-j">
                                        <label class="form-check-label d-flex justify-content-between w-100" for="dropdown-dp-j">
                                            <span>Jefatura</span>
                                            <span class="text-muted" id="dropdown-count-j">(0)</span>
                                        </label>
                                    </li>

                                    <li class="form-check my-2">
                                        <input class="form-check-input filter-departamento" type="checkbox" value="Legal" id="dropdown-dp-l">
                                        <label class="form-check-label d-flex justify-content-between w-100" for="dropdown-dp-l">
                                            <span>Legal</span>
                                            <span class="text-muted" id="dropdown-count-l">(0)</span>
                                        </label>
                                    </li>

                                    <li class="form-check my-2">
                                        <input class="form-check-input filter-departamento" type="checkbox" value="Operaciones" id="dropdown-dp-o">
                                        <label class="form-check-label d-flex justify-content-between w-100" for="dropdown-dp-o">
                                            <span>Operaciones</span>
                                            <span class="text-muted" id="dropdown-count-o">(0)</span>
                                        </label>
                                    </li>

                                    <li class="form-check my-2">
                                        <input class="form-check-input filter-departamento" type="checkbox" value="Recursos Humanos" id="dropdown-dp-rrhh">
                                        <label class="form-check-label d-flex justify-content-between w-100" for="dropdown-dp-rrhh">
                                            <span>Recursos Humanos</span>
                                            <span class="text-muted" id="dropdown-count-rrhh">(0)</span>
                                        </label>
                                    </li>

                                    <li class="form-check my-2">
                                        <input class="form-check-input filter-departamento" type="checkbox" value="Tecnicos NCR" id="dropdown-dp-tncr">
                                        <label class="form-check-label d-flex justify-content-between w-100" for="dropdown-dp-tncr">
                                            <span>Técnicos NCR</span>
                                            <span class="text-muted" id="dropdown-count-tncr">(0)</span>
                                        </label>
                                    </li>

                                    <li class="form-check my-2">
                                        <input class="form-check-input filter-departamento" type="checkbox" value="Tecnologias de Informacion" id="dropdown-dp-ti">
                                        <label class="form-check-label d-flex justify-content-between w-100" for="dropdown-dp-ti">
                                            <span>Tecnologías de Información</span>
                                            <span class="text-muted" id="dropdown-count-ti">(0)</span>
                                        </label>
                                    </li>

                                    <li class="form-check my-2">
                                        <input class="form-check-input filter-departamento" type="checkbox" value="Ventas" id="dropdown-dp-v">
                                        <label class="form-check-label d-flex justify-content-between w-100" for="dropdown-dp-v">
                                            <span>Ventas</span>
                                            <span class="text-muted" id="dropdown-count-v">(0)</span>
                                        </label>
                                    </li>
                                </ul>
                            </div>

                            <!-- FILTRO POR NOMBRE -->
                            <div class="mb-3 pb-1 border-bottom">
                                <button class="btn w-100 d-flex justify-content-between align-items-center p-0 text-dark fw-semibold"
                                        type="button" data-bs-toggle="collapse" data-bs-target="#nameFilter" aria-expanded="true">
                                    Nombre del Empleado
                                    <i class="bi bi-chevron-down"></i>
                                </button>

                                <div class="collapse show mt-3" id="nameFilter">
                                    <div class="input-group">
                                        <span class="input-group-text bg-white border-end-0">
                                            <i class="bi bi-search"></i>
                                        </span>
                                        <input type="text"
                                               class="form-control border-start-0 filter-name"
                                               id="filter-name-input"
                                               placeholder="Escribir nombre..."
                                               aria-label="Buscar por nombre">
                                    </div>
                                    <div class="form-text mt-1">Escribe parte del nombre para buscar</div>
                                </div>
                            </div>

                            <!-- FILTRO POR FECHA -->
                            <div class="mb-3 pb-1 border-bottom">
                                <button class="btn w-100 d-flex justify-content-between align-items-center p-0 text-dark fw-semibold"
                                        type="button" data-bs-toggle="collapse" data-bs-target="#dateFilter" aria-expanded="false">
                                    Fecha
                                    <i class="bi bi-chevron-down"></i>
                                </button>

                                <div class="collapse mt-3" id="dateFilter">

                                    <!-- ACTIVAR RANGO -->
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="dateRangeSwitch">
                                        <label class="form-check-label" for="dateRangeSwitch">Buscar por rango</label>
                                    </div>

                                    <!-- FECHA ÚNICA -->
                                    <div id="singleDateContainer">
                                        <label class="form-label">Fecha</label>
                                        <input type="date" class="form-control filter-date" id="filter-date-single">
                                    </div>

                                    <!-- RANGO DE FECHAS -->
                                    <div id="rangeDateContainer" class="d-none">
                                        <label class="form-label">Desde</label>
                                        <input type="date" class="form-control mb-2 filter-date" id="filter-date-from">

                                        <label class="form-label">Hasta</label>
                                        <input type="date" class="form-control filter-date" id="filter-date-to">
                                    </div>

                                </div>
                            </div>

                            <!-- Clear Filters -->
                            <button class="btn w-100 text-primary-custom fw-medium pt-3 border-top" id="clear-filters">
                                Limpiar filtros
                            </button>
                        </div>
                    </div>
                </div>

                <!-- CONTENIDO DE CARDS -->
                <div class="col-lg-9">
                    <div id="constanciasContainer">
                        <!-- constanciaass will be dynamically loaded here -->
                    </div>

                    <!-- Pagination -->
                    <nav class="mt-4">
                        <ul class="pagination justify-content-center mb-0" id="pagination">
                            <!-- Pagination will be dynamically generated here -->
                        </ul>
                    </nav>
                </div>

            </div>
        </div>
    </main>

    <!-- Modal de la Foto -->
    <div class="modal fade" id="fotoModal" tabindex="-1" aria-labelledby="fotoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <img id="modalFoto" src="" alt="Foto ampliada" class="img-fluid rounded" />
                </div>
            </div>
        </div>
    </div>
    <script>
        function mostrarImagenModal(base64) {
            var modalImg = document.getElementById("modalFoto");
            modalImg.src = "data:image/jpeg;base64," + base64;
        }
    </script>

    <!-- Respuestas de los Formularios -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Para mensajes de error
            @if (TempData["ErrorMessageCons"] != null)
            {
                <text>
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: '@Html.Raw(TempData["ErrorMessageCons"])',
                        confirmButtonText: 'Aceptar'
                    });
                </text>
            }

            // Para mensajes de éxito
            @if (TempData["SuccessMessageCons"] != null)
            {
                <text>
                    Swal.fire({
                        icon: 'success',
                        title: 'Éxito',
                        text: '@Html.Raw(TempData["SuccessMessageCons"])',
                        confirmButtonText: 'Aceptar',
                        timer: 3000
                    });
                </text>
            }
        });
    </script>

    <!-- Modal de Constancia Salarial -->
    <div class="modal fade" id="modalSalarial" tabindex="-1" aria-labelledby="modalSalarialLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalSalarialLabel">Campos a Llenar</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formSalarial" action="@Url.Action("HacerConstanciaSalarial", "Constancia")" method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" id="idConstancia" name="idConstancia">

                        <div class="mb-3">
                            <label for="salarioBruto" class="form-label">Salario Bruto</label>
                            <input type="number" class="form-control" id="salarioBruto" name="salarioBruto" min="0" required>
                        </div>

                        <div class="mb-3">
                            <label for="deducciones" class="form-label">Deducciones</label>
                            <input type="number" class="form-control" id="deducciones" name="deducciones" min="0" required>
                        </div>

                        <div class="mb-3">
                            <label for="salarioNeto" class="form-label">Salario Neto</label>
                            <input type="number" class="form-control" id="salarioNeto" name="salarioNeto" min="0" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning" onclick="enviarFormulario()">Guardar</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        function abrirModalSalarial(idConstancia) {
            // Guardar el ID en el hidden field
            document.getElementById('idConstancia').value = idConstancia;

            // Limpiar campos
            document.getElementById('salarioBruto').value = '';
            document.getElementById('deducciones').value = '';
            document.getElementById('salarioNeto').value = '';

            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('modalSalarial'));
            modal.show();
        }

        function enviarFormulario() {
            // Enviar el formulario directamente al controlador
            document.getElementById('formSalarial').submit();
        }
    </script>

    <!-- FUNCION DE DESCARGA DE EXCEL -->
    <script>
        //Funciones para descargar excel
        document.getElementById('exportExcelBtnC').addEventListener('click', function() {
            const button = this;

            // Mostrar indicador de carga
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="bi bi-arrow-repeat spinner-border spinner-border-sm me-2"></i>Generando Excel...';
            button.disabled = true;

            // Construir parámetros de filtros
            const params = new URLSearchParams();

            // Agregar tipos
            filtrosActivos.tipos.forEach(tipo => {
                params.append('tipos', tipo);
            });

            // Agregar estados
            filtrosActivos.estados.forEach(estado => {
                params.append('estados', estado);
            });

            // Agregar departamentos
            filtrosActivos.departamentos.forEach(depto => {
                params.append('departamentos', depto);
            });

            // Agregar nombres
            if (filtrosActivos.nombre) {
                params.append('nombre', filtrosActivos.nombre);
            }

            // Agregar filtros de fecha
            if (filtrosActivos.fecha.tipo) {
                params.append('fechaTipo', filtrosActivos.fecha.tipo);

                if (filtrosActivos.fecha.tipo === 'single' && filtrosActivos.fecha.fechaUnica) {
                    params.append('fechaUnica', filtrosActivos.fecha.fechaUnica);
                } else if (filtrosActivos.fecha.tipo === 'range') {
                    if (filtrosActivos.fecha.fechaDesde) {
                        params.append('fechaDesde', filtrosActivos.fecha.fechaDesde);
                    }
                    if (filtrosActivos.fecha.fechaHasta) {
                        params.append('fechaHasta', filtrosActivos.fecha.fechaHasta);
                    }
                }
            }

            // Crear enlace de descarga directa
            const downloadLink = document.createElement('a');
            downloadLink.href = `/Constancia/ExportarConstanciasExcel?${params.toString()}`;
            downloadLink.download = `Constancias_${new Date().toISOString().slice(0, 19).replace(/:/g, '')}.xlsx`;
            downloadLink.style.display = 'none';

            // Agregar event listener para restaurar el botón cuando la descarga termine
            downloadLink.addEventListener('click', function() {
                // Pequeño delay para asegurar que la descarga inició
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 1000);
            });

            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);

            // También restaurar el botón después de un tiempo máximo por si falla
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            }, 5000); // Máximo 5 segundos
        });
    </script>

    <!-- FUNCION DE DESCARGA DE PDF -->
    <script>
        document.getElementById('exportPdfBtnC').addEventListener('click', async function() {
            const button = this;
            try {
                // Mostrar indicador de carga
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="bi bi-arrow-repeat spinner-border spinner-border-sm me-2"></i>Generando PDF...';
                button.disabled = true;

                // Construir parámetros de filtros (misma lógica que Excel)
                const params = new URLSearchParams();

                // Agregar tipos
                filtrosActivos.tipos.forEach(tipo => {
                    params.append('tipos', tipo);
                });

                // Agregar estados
                filtrosActivos.estados.forEach(estado => {
                    params.append('estados', estado);
                });

                // Agregar departamentos
                filtrosActivos.departamentos.forEach(depto => {
                    params.append('departamentos', depto);
                });

                // Agregar nombres
                if (filtrosActivos.nombre) {
                    params.append('nombre', filtrosActivos.nombre);
                }

                // Agregar filtros de fecha
                if (filtrosActivos.fecha.tipo) {
                    params.append('fechaTipo', filtrosActivos.fecha.tipo);

                    if (filtrosActivos.fecha.tipo === 'single' && filtrosActivos.fecha.fechaUnica) {
                        params.append('fechaUnica', filtrosActivos.fecha.fechaUnica);
                    } else if (filtrosActivos.fecha.tipo === 'range') {
                        if (filtrosActivos.fecha.fechaDesde) {
                            params.append('fechaDesde', filtrosActivos.fecha.fechaDesde);
                        }
                        if (filtrosActivos.fecha.fechaHasta) {
                            params.append('fechaHasta', filtrosActivos.fecha.fechaHasta);
                        }
                    }
                }

                // Realizar la solicitud
                const response = await fetch(`/Constancia/ExportarConstanciasPDF?${params.toString()}`);

                if (response.ok) {
                    // Obtener el blob
                    const blob = await response.blob();

                    // Restaurar el botón inmediatamente
                    button.innerHTML = originalText;
                    button.disabled = false;

                    // Descargar el archivo
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `Constancias_${new Date().toISOString().slice(0, 19).replace(/:/g, '')}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                } else {
                    throw new Error('Error al generar el PDF');
                }
            } catch (error) {
                console.error('Error al exportar a PDF:', error);
                alert('Error al generar el archivo PDF');

                // Restaurar el botón en caso de error
                button.innerHTML = originalText;
                button.disabled = false;
            }
        });
    </script>

    <!-- PARA ICONOS -->
    <script>
        // Función para obtener icono según tipo de archivo
        function obtenerIconoArchivo(nombreArchivo, tipoMIME) {
            const extension = obtenerExtension(nombreArchivo).toLowerCase();

            const iconos = {
                'pdf': 'bi-file-pdf',
                'doc': 'bi-file-word',
                'docx': 'bi-file-word',
                'xls': 'bi-file-excel',
                'xlsx': 'bi-file-excel',
                'ppt': 'bi-file-ppt',
                'pptx': 'bi-file-ppt',
                'jpg': 'bi-file-image',
                'jpeg': 'bi-file-image',
                'png': 'bi-file-image',
                'gif': 'bi-file-image',
                'zip': 'bi-file-zip',
                'rar': 'bi-file-zip'
            };

            const icono = iconos[extension] || 'bi-file-earmark';
            return `<i class="bi ${icono} me-1"></i>`;
        }

        // Función para obtener extensión del archivo
        function obtenerExtension(nombreArchivo) {
            return nombreArchivo.split('.').pop() || 'file';
        }

        // Función para formatear tamaño de archivo
        function formatearTamanoArchivo(bytes) {
            if (bytes === 0 || !bytes) return '0 B';

            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));

            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>

    <!-- FILTRADO Y CONTADORES MEJORADOS -->
    <script>
        const constanciasPaginaActual = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Constancias));
        const totalPaginas = @Model.TotalPaginas;
        let paginaActual = @Model.PaginaActual;

        const constanciasContainer = document.getElementById("constanciasContainer");
        const pagination = document.getElementById("pagination");

        // Estado global de filtros
        let filtrosActivos = {
            tipos: [],
            estados: [],
            departamentos: [],
            nombre: '',
            fecha: {
                tipo: 'single',
                fechaUnica: null,
                fechaDesde: null,
                fechaHasta: null
            }
        };

        // Función para construir parámetros de filtro
        function construirParametrosFiltros() {
            const params = new URLSearchParams();

            // Tipos
            filtrosActivos.tipos.forEach(tipo => {
                params.append('tipos', tipo);
            });

            // Estados
            filtrosActivos.estados.forEach(estado => {
                params.append('estados', estado);
            });

            // Departamentos
            filtrosActivos.departamentos.forEach(depto => {
                params.append('departamentos', depto);
            });

            // Nombre
            if (filtrosActivos.nombre && filtrosActivos.nombre.trim().length > 0) {
                params.append('nombre', filtrosActivos.nombre.trim());
            }

            // Fechas
            if (filtrosActivos.fecha.tipo) {
                params.append('fechaTipo', filtrosActivos.fecha.tipo);

                if (filtrosActivos.fecha.tipo === 'single' && filtrosActivos.fecha.fechaUnica) {
                    params.append('fechaUnica', filtrosActivos.fecha.fechaUnica);
                } else if (filtrosActivos.fecha.tipo === 'range') {
                    if (filtrosActivos.fecha.fechaDesde) {
                        params.append('fechaDesde', filtrosActivos.fecha.fechaDesde);
                    }
                    if (filtrosActivos.fecha.fechaHasta) {
                        params.append('fechaHasta', filtrosActivos.fecha.fechaHasta);
                    }
                }
            }

            return params;
        }

        // Inicializar contadores con TODAS las constancias
        async function filtrarConstancias() {
            try {
                // Mostrar loader
                constanciasContainer.innerHTML = `
                    <div class="text-center py-5" id="filter-loading">
                        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-3 text-primary fw-semibold fs-5">Aplicando filtros...</p>
                        <p class="text-muted">Por favor espere un momento</p>
                    </div>
                `;

                constanciasContainer.style.opacity = '1';

                const params = construirParametrosFiltros();
                const response = await fetch(`/Constancia/ObtenerConstanciasFiltradasCompletas?${params.toString()}`);

                if (response.ok) {
                    const constanciasFiltradas = await response.json();
                    return constanciasFiltradas;
                } else {
                    return [];
                }

            } catch (error) {
                return [];
            }
        }

        // Función para aplicar filtros y renderizar
        async function aplicarFiltros() {
            const constanciasFiltradas = await filtrarConstancias();

            // Asegurar que el mensaje de "Aplicando filtros..." se vea por al menos 1 segundo
            setTimeout(async () => {
                await renderConstanciasWithFade(constanciasFiltradas);

                // Ocultar paginación cuando hay filtros activos
                const hayFiltrosActivos =
                    filtrosActivos.tipos.length > 0 ||
                    filtrosActivos.estados.length > 0 ||
                    filtrosActivos.departamentos.length > 0 ||
                    (filtrosActivos.nombre && filtrosActivos.nombre.trim().length > 0) ||
                    (filtrosActivos.fecha.tipo === 'single' && filtrosActivos.fecha.fechaUnica) ||
                    (filtrosActivos.fecha.tipo === 'range' && (filtrosActivos.fecha.fechaDesde || filtrosActivos.fecha.fechaHasta));

                pagination.style.display = hayFiltrosActivos ? 'none' : 'flex';
            }, 1200); // 1 segundo de delay mínimo
        }

        // Función para actualizar filtro de fecha
        function actualizarFiltroFecha() {
            const isRange = document.getElementById('dateRangeSwitch').checked;

            if (isRange) {
                filtrosActivos.fecha.tipo = 'range';
                filtrosActivos.fecha.fechaUnica = null;
                filtrosActivos.fecha.fechaDesde = document.getElementById('filter-date-from').value;
                filtrosActivos.fecha.fechaHasta = document.getElementById('filter-date-to').value;
            } else {
                filtrosActivos.fecha.tipo = 'single';
                filtrosActivos.fecha.fechaDesde = null;
                filtrosActivos.fecha.fechaHasta = null;
                filtrosActivos.fecha.fechaUnica = document.getElementById('filter-date-single').value;
            }
        }

        // Función para inicializar contadores con TODAS las constancias
        async function inicializarContadores() {
            try {
                const response = await fetch('/Constancia/ObtenerContadoresFiltros');
                if (response.ok) {
                    const contadores = await response.json();

                    // Actualizar contadores de tipos
                    document.getElementById('count-laboral').textContent = `(${contadores.laboral})`;
                    document.getElementById('count-salarial').textContent = `(${contadores.salarial})`;
                    
                    // Actualizar contadores de estados
                    document.getElementById('count-creada').textContent = `(${contadores.creada})`;
                    document.getElementById('count-approved').textContent = `(${contadores.aprobada})`;
                    document.getElementById('count-pending').textContent = `(${contadores.pendiente})`;
                    document.getElementById('count-rejected').textContent = `(${contadores.rechazada})`;

                    // Actualizar contadores de departamentos
                    document.getElementById('dropdown-count-bo').textContent = `(${contadores.bodega})`;
                    document.getElementById('dropdown-count-fc').textContent = `(${contadores.financieroContable})`;
                    document.getElementById('dropdown-count-g').textContent = `(${contadores.gerencia})`;
                    document.getElementById('dropdown-count-i').textContent = `(${contadores.ingenieria})`;
                    document.getElementById('dropdown-count-j').textContent = `(${contadores.jefatura})`;
                    document.getElementById('dropdown-count-l').textContent = `(${contadores.legal})`;
                    document.getElementById('dropdown-count-o').textContent = `(${contadores.operaciones})`;
                    document.getElementById('dropdown-count-rrhh').textContent = `(${contadores.recursosHumanos})`;
                    document.getElementById('dropdown-count-tncr').textContent = `(${contadores.tecnicosNCR})`;
                    document.getElementById('dropdown-count-ti').textContent = `(${contadores.tecnologiasInformacion})`;
                    document.getElementById('dropdown-count-v').textContent = `(${contadores.ventas})`;
                } else {
                    console.error('Error al cargar contadores del servidor');
                }
            } catch (error) {
                console.error('Error cargando contadores:', error);
            }
        }

        // Función para aplicar fade out
        function fadeOut(element, callback) {
            element.style.transition = 'opacity 0.5s ease';
            element.style.opacity = '0';

            setTimeout(() => {
                callback();
                setTimeout(() => {
                    element.style.transition = 'opacity 0.5s ease';
                    element.style.opacity = '1';
                }, 100);
            }, 500);
        }

        // Función para aplicar fade in
        function fadeIn(element) {
            element.style.transition = 'opacity 0.5s ease';
            element.style.opacity = '0';

            setTimeout(() => {
                element.style.transition = 'opacity 0.5s ease';
                element.style.opacity = '1';
            }, 50);
        }

        // Función para renderizar constancias con efectos de fade
        async function renderConstanciasWithFade(data) {
            fadeOut(constanciasContainer, () => {
                renderConstancias(data);
            });
        }

        // Función para renderizar constancias
        function renderConstancias(data) {
        @{
            bool esEmpNormal = User.IsInRole("Empleado Normal");
            bool esJef = User.IsInRole("Jefatura");
            bool esRrhh = User.IsInRole("RRHH");
            bool esAdmin = User.IsInRole("Administrador");
        }

        const esEmpleadoNormal = @esEmpNormal.ToString().ToLower();
        const esJefatura = @esJef.ToString().ToLower();
        const esRRHH = @esRrhh.ToString().ToLower();
        const esAdministrador = @esAdmin.ToString().ToLower();

        const tieneRolAlto = esRRHH === true || esAdministrador === true;

            if (data.length === 0) {
                constanciasContainer.innerHTML = `
                    <div class="no-results">
                        <i class="bi bi-inbox display-1 d-block mb-3"></i>
                        <h3 class="h4 text-muted">No se encontraron constancias</h3>
                        <p class="text-muted">Intenta ajustar los filtros para ver más resultados.</p>
                    </div>
                `;
                // Aplicar fade in al contenido vacío
                fadeIn(constanciasContainer);
                return;
            }

            constanciasContainer.innerHTML = data.map(constanciaas => `
            <div class="card constancia-card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-end">
                            <input type="checkbox"
                                   class="form-check-input permiso-check"
                                   value="${constanciaas.idConstancia}"
                                   style="width:18px; height:18px; cursor:pointer; padding:10px; box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);">
                        </div>
                        <div class="mb-2"
                         style="cursor: pointer;"
                         onclick="window.location.href='/Constancia/Details/${constanciaas.idConstancia}'">
                            <div class="d-flex align-items-start justify-content-between gap-1 mb-2 flex-wrap">
                                <h3 class="h6 fw-bold text-dark mb-0" style="padding: 5px">
                                    <i class="fa-solid fa-user me-3"></i>${constanciaas.nombreEmpleado}
                                </h3>
                                <h5 class="h6 text-white small mb-0" style="padding: 5px; background-color: #012473; border-radius: 5px">
                                    #${constanciaas.idConstancia}
                                </h5>
                            </div>
                            <div class="d-flex align-items-center flex-wrap mb-2" style="gap: 1.5rem; padding-left: 5%; padding-right: 5%;">
                                <span class="badge custom-badge ${
                                    constanciaas.estado === "Creada" || constanciaas.estado === "Aprobada"
                                        ? "bg-success"
                                        : constanciaas.estado === "Pendiente"
                                            ? "bg-warning"
                                            : constanciaas.estado === "Rechazada"
                                                ? "bg-danger"
                                                : "bg-secondary"
                                }">
                                    ${constanciaas.estado}
                                </span>
                                <span class="badge custom-badge"
                                      style="
                                        background-color: ${
                                            constanciaas.tipo === 'Laboral' ? '#F58E53' :
                                            constanciaas.tipo === 'Salarial' ? '#dc3545' :
                                            '#6c757d'
                                        };
                                        color: #fff;
                                      ">
                                    ${constanciaas.tipo}
                                </span>

                                <!-- AGREGAR BADGE DE DEPARTAMENTO -->
                                ${constanciaas.departamento ? `
                                <span class="badge colorcito text-white">
                                    ${constanciaas.departamento}
                                </span>
                                ` : ''}
                            </div>
                            <div class="row small d-flex justify-content-around" style="gap: 1.5rem; padding-left: 5%; padding-right: 5%;">
                                <div class="col-2" style="display: flex;flex-direction: column;">
                                    <span class="text-muted fw-semibold">Creación:</span>
                                    <span class="text-dark fw-medium ms-1">${new Date(constanciaas.fechaCreacion + "T00:00:00").toLocaleDateString('es-CR')}</span>
                                </div>
                                ${constanciaas.tipo === "Laboral" ? `
                                    <div class="col-2" style="display: flex;flex-direction: column;">
                                        <span class="text-muted fw-semibold">Dirigido:</span>
                                        <span class="${constanciaas.dirijido ? 'text-dark fw-medium' : 'text-danger fw-bold'} ms-1">
                                            ${constanciaas.dirijido ? constanciaas.dirijido : 'N/A'}
                                        </span>
                                    </div>
                                ` : ''}
                                <div class="col-2" style="display: flex;flex-direction: column;">
                                    <span class="text-muted fw-semibold">Requerida:</span>
                                    <span class="text-dark fw-medium ms-1">${new Date(constanciaas.fechaRequerida).toLocaleDateString('es-CR')}</span>
                                </div>
                            </div>
                        </div>

                        <div class="pt-2 border-top">
                            <div class="row small d-flex align-items-center flex-wrap justify-content-around" style="gap: 0.5rem; padding-left: 5%; padding-right: 5%;">
                                <div class="col d-flex align-items-center gap-1">
                                    <span class="text-muted fw-semibold d-block">Comentarios:</span>
                                    <span class="text-dark fw-medium ms-1" d-block>${constanciaas.comentarios ?? 'Sin comentario'}</span>
                                </div>
                                <div class="col d-flex align-items-center gap-2">
                                    ${
                                        // Verificar si existe archivo adjunto
                                        constanciaas.nombreArchivo && constanciaas.nombreArchivo.trim() !== ''
                                            ? (
                                                // CASO: SÍ HAY ARCHIVO ADJUNTO
                                                constanciaas.estado === "Aprobada"
                                                    // ✅ ESTADO APROBADA - TODOS PUEDEN DESCARGAR (SALARIAL O LABORAL)
                                                    ? `
                                                        <div class="mt-1 d-flex align-items-center gap-1">
                                                            <a href="/Constancia/descargar-adjunto/${constanciaas.idConstancia}"
                                                                class="btn btn-sm btn-outline-primary d-flex align-items-center"
                                                                style="font-size: 0.75rem; padding: 0.25rem 0.5rem; width: 80%"
                                                                title="Descargar ${constanciaas.nombreArchivo}">
                                                                ${obtenerIconoArchivo(constanciaas.nombreArchivo, constanciaas.tipoMIME)}
                                                                <span class="text-truncate d-block" style="max-width: 220px;">
                                                                    ${constanciaas.nombreArchivo}
                                                                </span>
                                                            </a>
                                                            <small class="text-muted text-center d-block mt-1">
                                                                ${formatearTamanoArchivo(constanciaas.tamanoArchivo)} •
                                                                ${obtenerExtension(constanciaas.nombreArchivo)}
                                                            </small>
                                                        </div>
                                                    `
                                                    // ESTADO CREADA O OTRO
                                                    : (
                                                        // Solo roles altos pueden ver/descargar constancias en estado "Creada"
                                                        tieneRolAlto
                                                            ? `
                                                                <div class="mt-1 d-flex align-items-center gap-2">
                                                                    <a href="/Constancia/descargar-adjunto/${constanciaas.idConstancia}"
                                                                        class="btn btn-sm btn-outline-primary d-flex align-items-center"
                                                                        style="font-size: 0.75rem; padding: 0.25rem 0.5rem; width: 80%"
                                                                        title="Descargar ${constanciaas.nombreArchivo}">
                                                                        ${obtenerIconoArchivo(constanciaas.nombreArchivo, constanciaas.tipoMIME)}
                                                                        <span class="text-truncate d-block" style="max-width: 220px;">
                                                                            ${constanciaas.nombreArchivo}
                                                                        </span>
                                                                    </a>

                                                                    <small class="text-muted text-center d-block mt-1">
                                                                        ${formatearTamanoArchivo(constanciaas.tamanoArchivo)} •
                                                                        ${obtenerExtension(constanciaas.nombreArchivo)}
                                                                    </small>

                                                                    ${constanciaas.estado !== "Aprobada"
                                                                        ? `                                                                        
                                                                        <button class="btn btn-primary btn-sm d-flex"
                                                                                onclick="abrirModalPDF(${constanciaas.idConstancia})">
                                                                            <small>subir firmada</small>
                                                                        </button>
                                                                        `
                                                                        : ''
                                                                    }
                                                                </div>
                                                            `
                                                            // Empleado Normal ve mensaje de aprobación pendiente
                                                            : `
                                                                <span class="text-danger d-inline-block text-center small"
                                                                    style="width:100%; padding: 0.25rem; background:#fff3cd; border-radius:5px;">
                                                                    Archivo disponible tras aprobación
                                                                </span>
                                                            `
                                                    )
                                            )
                                            // CASO: NO HAY ARCHIVO ADJUNTO
                                            : (
                                                // Solo roles altos pueden crear constancias Salariales
                                                constanciaas.tipo === "Salarial" && constanciaas.estado === "Creada" && tieneRolAlto
                                                    ? `
                                                        <button class="btn btn-sm btn-warning w-100"
                                                                onclick="abrirModalSalarial(${constanciaas.idConstancia})">
                                                            Crear Constancia Salarial
                                                        </button>
                                                    `
                                                    // Estado "Aprobada" sin archivo
                                                    : constanciaas.estado === "Aprobada"
                                                    ? `
                                                        <span class="text-danger d-inline-block text-center small"
                                                            style="width:100%; padding: 0.25rem; background:#fff3cd; border-radius:5px;">
                                                            Constancia aprobada sin archivo adjunto
                                                        </span>
                                                    `
                                                    // Estado "Creada" sin archivo para Empleado Normal
                                                    : constanciaas.estado === "Creada"
                                                    ? `
                                                        <span class="text-warning d-inline-block text-center small"
                                                            style="width:100%; padding: 0.25rem; background:#fff8e1; border-radius:5px;">
                                                            Constancia en proceso de creación
                                                        </span>
                                                    `
                                                    // Otros casos
                                                    : `
                                                        <span class="text-muted d-inline-block text-center small"
                                                            style="width:100%; padding: 0.25rem; background:#f0f0f0; border-radius:5px;">
                                                            Sin archivo
                                                        </span>
                                                    `
                                            )
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            // Aplicar fade in al nuevo contenido
            fadeIn(constanciasContainer);
        }

        function renderPagination() {
            pagination.innerHTML = '';
            for (let i = 1; i <= totalPaginas; i++) {
                pagination.innerHTML += `
                    <li class="page-item ${i === paginaActual ? 'active' : ''}">
                        <a class="page-link" href="?page=${i}">${i}</a>
                    </li>
                `;
            }
        }

        // Función debounce para optimizar búsquedas por nombre
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ================= EVENT LISTENERS =================
        document.addEventListener('DOMContentLoaded', function() {

            // Event listeners para tipos
            document.querySelectorAll('.filter-type').forEach(checkbox => {
                checkbox.addEventListener('change', async function() {
                    if (this.checked) {
                        filtrosActivos.tipos.push(this.value);
                    } else {
                        filtrosActivos.tipos = filtrosActivos.tipos.filter(tipo => tipo !== this.value);
                    }
                    await aplicarFiltros();
                });
            });

            // Event listeners para estados
            document.querySelectorAll('.filter-status').forEach(checkbox => {
                checkbox.addEventListener('change', async function() {
                    if (this.checked) {
                        filtrosActivos.estados.push(this.value);
                    } else {
                        filtrosActivos.estados = filtrosActivos.estados.filter(estado => estado !== this.value);
                    }
                    await aplicarFiltros();
                });
            });

            // Event listeners para departamentos
            document.querySelectorAll('.filter-departamento').forEach(checkbox => {
                checkbox.addEventListener('change', async function() {
                    if (this.checked) {
                        filtrosActivos.departamentos.push(this.value);
                    } else {
                        filtrosActivos.departamentos = filtrosActivos.departamentos.filter(depto => depto !== this.value);
                    }
                    await aplicarFiltros();
                });
            });

            // Event listener para nombre
            const inputNombre = document.getElementById('filter-name-input');

            if (inputNombre) {
                inputNombre.addEventListener('input', debounce(async function (e) {
                    const valor = e.target.value || '';
                    filtrosActivos.nombre = valor.trim();
                    await aplicarFiltros();
                }, 1000));
            }

            // Event listeners para fechas
            document.querySelectorAll('.filter-date').forEach(input => {
                input.addEventListener('change', async function() {
                    actualizarFiltroFecha();
                    await aplicarFiltros();
                });
            });

            // Switch de rango de fechas
            const dateSwitch = document.getElementById("dateRangeSwitch");
            if (dateSwitch) {
                dateSwitch.addEventListener("change", function() {
                    const isRange = this.checked;
                    document.getElementById("singleDateContainer").classList.toggle("d-none", isRange);
                    document.getElementById("rangeDateContainer").classList.toggle("d-none", !isRange);

                    // Limpiar inputs no utilizados
                    if (isRange) {
                        document.getElementById('filter-date-single').value = '';
                    } else {
                        document.getElementById('filter-date-from').value = '';
                        document.getElementById('filter-date-to').value = '';
                    }

                    actualizarFiltroFecha();
                });
            }

            // Limpiar filtros
            document.getElementById('clear-filters').addEventListener('click', function() {
                // Desmarcar checkboxes
                document.querySelectorAll('.filter-type, .filter-status, .filter-departamento').forEach(checkbox => {
                    checkbox.checked = false;
                });

                // Limpiar inputs
                document.getElementById('filter-name-input').value = '';
                document.getElementById('filter-date-single').value = '';
                document.getElementById('filter-date-from').value = '';
                document.getElementById('filter-date-to').value = '';
                document.getElementById('dateRangeSwitch').checked = false;
                document.getElementById("singleDateContainer").classList.remove("d-none");
                document.getElementById("rangeDateContainer").classList.add("d-none");

                // Limpiar estado de filtros
                filtrosActivos.tipos = [];
                filtrosActivos.estados = [];
                filtrosActivos.departamentos = [];
                filtrosActivos.nombre = '';
                filtrosActivos.fecha = {
                    tipo: 'single',
                    fechaUnica: null,
                    fechaDesde: null,
                    fechaHasta: null
                };

                // Mostrar constancias iniciales (de la paginación)
                renderConstanciasWithFade(constanciasPaginaActual);
                pagination.style.display = 'flex';
            });

            // Inicializar contadores y renderizar
            (async function() {
                await inicializarContadores();
                constanciasContainer.style.opacity = '0';
                renderConstancias(constanciasPaginaActual);
                renderPagination();
            })();
        });
    </script>

    <!-- SCRIPT DE SUBIR PDF -->
    <div class="modal fade" id="pdfModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form method="post"
                      asp-action="ArchivoPDF"
                      asp-controller="Constancia"
                      enctype="multipart/form-data">

                    @Html.AntiForgeryToken()

                    <input type="hidden" id="idConstanciaInput" name="idConstancia" value="" />
                    <div class="modal-header">
                        <h5 class="modal-title">Subir documento firmado</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>

                    <div class="modal-body">
                        <input type="file"
                               id="pdfInput"
                               name="archivoPdf"
                               accept="application/pdf"
                               class="form-control"
                               required>

                        <small class="text-muted d-block mt-2">
                            *Solo archivos PDF
                        </small>
                    </div>

                    <div class="modal-footer">
                        <button type="button"
                                class="btn btn-secondary btn-sm"
                                data-bs-dismiss="modal">
                            Cancelar
                        </button>

                        <button type="submit"
                                class="btn btn-primary btn-sm">
                            Enviar
                        </button>
                    </div>

                </form>
            </div>
        </div>
    </div>
    <script>
        // Cuando hagas clic en "subir firmada", pasa el ID
        function abrirModalPDF(idConstancia) {
            document.getElementById('idConstanciaInput').value = idConstancia;
            const modal = new bootstrap.Modal(document.getElementById('pdfModal'));
            modal.show();
        }
    </script>

    <!-- MODAL CAMBIAR ESTADO -->
    <div class="modal fade" id="estadoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Cambiar estado</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body text-center">

                    <input type="hidden" id="constanciaIdSeleccionada">

                    <p class="mb-3">Seleccione el nuevo estado:</p>

                    <button class="btn btn-warning w-100 mb-2"
                            onclick="cambiarEstado('Pendiente')">
                        Pendiente
                    </button>

                    <button class="btn btn-danger w-100 mb-2"
                            onclick="cambiarEstado('Rechazada')">
                        Rechazada
                    </button>

                    <button class="btn btn-outline-success w-100 mb-2"
                            onclick="cambiarEstado('Aprobada')">
                        Aprobada
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script>
        function abrirModalMasivo() {
            const seleccionados = [...document.querySelectorAll(".permiso-check:checked")]
                .map(c => parseInt(c.value));

            if (seleccionados.length === 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Debes seleccionar mínimo una constancia',
                    confirmButtonText: 'Aceptar'
                });
                return;
            }

            window.idsSeleccionados = seleccionados;
            document.getElementById("constanciaIdSeleccionada").value = "";

            const modal = new bootstrap.Modal(document.getElementById('estadoModal'));
            modal.show();
        }
    </script>
    <script>
        function cambiarEstado(nuevoEstado) {

            const idIndividual = document.getElementById("constanciaIdSeleccionada").value;

            const ids = window.idsSeleccionados?.length
                ? window.idsSeleccionados
                : [parseInt(idIndividual)];

            fetch("/Constancia/CambiarEstadoMasivo", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ ids, estado: nuevoEstado })
            })
            .then(res => res.json())
            .then(data => {

                // Cerrar modal
                bootstrap.Modal.getInstance(
                    document.getElementById("estadoModal")
                ).hide();

                // Redirigir para que muestre TempData
                if (data.redirect) {
                    window.location.href = data.redirect;
                }
            })
            .catch(err => console.error(err));
        }
    </script>
</body>
</html>