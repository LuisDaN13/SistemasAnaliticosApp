@model SistemasAnaliticos.DTO.PaginacionPermisosDTO

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        .bg-gradient-custom {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        :root {
            --primary-color: #012473;
            --secondary-color: #013599;
            --danger-color: #E00319;
            --success-color: #198754;
        }

        .header-card {
            border-radius: 12px;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            background-color: white;
        }
    </style>
    <style>
        .category-header {
            cursor: pointer;
            transition: background-color 0.3s;
        }

            .category-header:hover {
                background-color: #f8f9fa !important;
            }

        .border-left-accent1 {
            border-left-color: #0d6efd;
            border-left-width: 4px !important;
            border-left-style: solid;
        }

        .border-left-accent2 {
            border-left-color: #146c43;
            border-left-width: 4px !important;
            border-left-style: solid;
        }

        .badge-status {
            font-size: 0.75rem;
            padding: 0.375rem 0.75rem;
        }

        .permission-item {
            transition: background-color 0.3s;
        }

            .permission-item:hover {
                background-color: #f8f9fa;
            }

        .action-btn {
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s;
        }

        .chevron-icon {
            color: #0d6efd;
            transition: transform 0.3s;
        }

        .chevron-rotated {
            transform: rotate(180deg);
        }
    </style>
    <style>
        .permission-card {
            transition: all 0.3s ease;
            border: 1px solid #dee2e6;
        }

            .permission-card:hover {
                box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
                border-color: var(--primary-color);
            }

        .filter-section {
            position: sticky;
            top: 5rem;
        }

        .no-results {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
    </style>
</head>
<body class="bg-gradient-custom min-vh-100">

    <!-- Main Content -->
    <main class="container-xxl px-4 px-sm-6 px-lg-8 py-4">

        <!-- Titulo de Permisos -->
        <div class="header-card p-4 mt-4 mb-4">
            <h1 class="h2 fw-bold text-gray-900 mb-2">Ver Todos los Permisos</h1>
            <p class="text-muted mb-0">Filtrado y observación de los permisos relacionados de los empleados de la empresa</p>
        </div>

        <!-- Permission Types Grid -->
        <div class="container my-4">
            <div class="row">
                <!-- FILTROS PARA CARDS -->
                <div class="col-lg-3">
                    <div class="card filter-section">
                        <div class="card-body">
                            <h2 class="h5 card-title fw-bold text-dark mb-4">Filtrar por</h2>

                            <!-- Type Filter -->
                            <div class="mb-4 pb-3 border-bottom">
                                <button class="btn w-100 d-flex justify-content-between align-items-center p-0 text-dark fw-semibold" type="button" data-bs-toggle="collapse" data-bs-target="#typeFilter" aria-expanded="true" aria-controls="typeFilter">
                                    Tipo de Permiso
                                    <i class="bi bi-chevron-down"></i>
                                </button>
                                <div class="collapse show mt-3" id="typeFilter">
                                    <div class="d-flex flex-column gap-2">
                                        <div class="form-check">
                                            <input class="form-check-input filter-type" type="checkbox" value="Cita Médica" id="type-medical">
                                            <label class="form-check-label d-flex justify-content-between w-100" for="type-medical">
                                                <span>Citas Médicas</span>
                                                <span class="text-muted" id="count-medical">(0)</span>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input filter-type" type="checkbox" value="Vacaciones" id="type-vacation">
                                            <label class="form-check-label d-flex justify-content-between w-100" for="type-vacation">
                                                <span>Vacaciones</span>
                                                <span class="text-muted" id="count-vacation">(0)</span>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input filter-type" type="checkbox" value="Incapacidad" id="type-incapacidad">
                                            <label class="form-check-label d-flex justify-content-between w-100" for="type-incapacidad">
                                                <span>Incapacidad</span>
                                                <span class="text-muted" id="count-incapacidad">(0)</span>
                                            </label>
                                        </div>                                        
                                        <div class="form-check">
                                            <input class="form-check-input filter-type" type="checkbox" value="Teletrabajo" id="type-teletrabajo">
                                            <label class="form-check-label d-flex justify-content-between w-100" for="type-teletrabajo">
                                                <span>Teletrabajo</span>
                                                <span class="text-muted" id="count-teletrabajo">(0)</span>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input filter-type" type="checkbox" value="Especial" id="type-especial">
                                            <label class="form-check-label d-flex justify-content-between w-100" for="type-especial">
                                                <span>Teletrabajo</span>
                                                <span class="text-muted" id="count-especial">(0)</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Status Filter -->
                            <div class="pb-3">
                                <button class="btn w-100 d-flex justify-content-between align-items-center p-0 text-dark fw-semibold" type="button" data-bs-toggle="collapse" data-bs-target="#statusFilter" aria-expanded="true" aria-controls="statusFilter">
                                    Estado
                                    <i class="bi bi-chevron-down"></i>
                                </button>
                                <div class="collapse show mt-3" id="statusFilter">
                                    <div class="d-flex flex-column gap-2">
                                        <div class="form-check">
                                            <input class="form-check-input filter-status" type="checkbox" value="Aprobado" id="status-approved">
                                            <label class="form-check-label d-flex justify-content-between w-100" for="status-approved">
                                                <span>Aprobado</span>
                                                <span class="text-muted" id="count-approved">(0)</span>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input filter-status" type="checkbox" value="Pendiente" id="status-pending">
                                            <label class="form-check-label d-flex justify-content-between w-100" for="status-pending">
                                                <span>Pendiente</span>
                                                <span class="text-muted" id="count-pending">(0)</span>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input filter-status" type="checkbox" value="Rechazado" id="status-rejected">
                                            <label class="form-check-label d-flex justify-content-between w-100" for="status-rejected">
                                                <span>Rechazado</span>
                                                <span class="text-muted" id="count-rejected">(0)</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Clear Filters -->
                            <button class="btn w-100 text-primary-custom fw-medium pt-3 border-top" id="clear-filters">
                                Limpiar filtros
                            </button>
                        </div>
                    </div>
                </div>

                <!-- CONTENIDO DE CARDS -->
                <div class="col-lg-9">
                    <div id="permissionsContainer">
                        <!-- Permissions will be dynamically loaded here -->
                    </div>

                    <!-- Pagination -->
                    <nav class="mt-4">
                        <ul class="pagination justify-content-center" id="pagination">
                            <!-- Pagination will be dynamically generated here -->
                        </ul>
                    </nav>
                </div>

            </div>
        </div>
    </main>

    <script>
        const permisos = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Permisos));
        const totalPaginas = @Model.TotalPaginas;
        let paginaActual = @Model.PaginaActual;

        const permissionsContainer = document.getElementById("permissionsContainer");
        const pagination = document.getElementById("pagination");

        // Estado de los filtros
        let filtrosActivos = {
            tipos: [],
            estados: []
        };

        // Inicializar contadores
        function inicializarContadores() {
            const contadoresTipo = {
                'Cita Médica': 0,
                'Vacaciones': 0,
                'Incapacidad': 0,
                'Teletrabajo': 0,
                'Especial': 0
            };

            const contadoresEstado = {
                'Aprobado': 0,
                'Pendiente': 0,
                'Rechazado': 0
            };

            // Contar permisos por tipo y estado
            permisos.forEach(permiso => {
                if (contadoresTipo.hasOwnProperty(permiso.tipo)) {
                    contadoresTipo[permiso.tipo]++;
                }

                // Mapear estados del backend a los del frontend
                let estadoFrontend = '';
                if (permiso.estado === "Creada" || permiso.estado === "Aprobada") {
                    estadoFrontend = "Aprobado";
                } else if (permiso.estado === "Pendiente") {
                    estadoFrontend = "Pendiente";
                } else if (permiso.estado === "Rechazada") {
                    estadoFrontend = "Rechazado";
                }

                if (contadoresEstado.hasOwnProperty(estadoFrontend)) {
                    contadoresEstado[estadoFrontend]++;
                }
            });

            // Actualizar contadores en la UI
            document.getElementById('count-medical').textContent = `(${contadoresTipo['Cita Médica']})`;
            document.getElementById('count-vacation').textContent = `(${contadoresTipo['Vacaciones']})`;
            document.getElementById('count-incapacidad').textContent = `(${contadoresTipo['Incapacidad']})`;
            document.getElementById('count-teletrabajo').textContent = `(${contadoresTipo['Teletrabajo']})`;
            document.getElementById('count-especial').textContent = `(${contadoresTipo['Especial']})`;

            document.getElementById('count-approved').textContent = `(${contadoresEstado['Aprobado']})`;
            document.getElementById('count-pending').textContent = `(${contadoresEstado['Pendiente']})`;
            document.getElementById('count-rejected').textContent = `(${contadoresEstado['Rechazado']})`;
        }

        // Función para filtrar permisos
        function filtrarPermisos() {
            let permisosFiltrados = permisos.filter(permiso => {
                // Filtrar por tipo
                const coincideTipo = filtrosActivos.tipos.length === 0 ||
                                   filtrosActivos.tipos.includes(permiso.tipo);

                // Filtrar por estado (mapear estados del backend)
                let estadoFrontend = '';
                if (permiso.estado === "Creada" || permiso.estado === "Aprobada") {
                    estadoFrontend = "Aprobado";
                } else if (permiso.estado === "Pendiente") {
                    estadoFrontend = "Pendiente";
                } else if (permiso.estado === "Rechazada") {
                    estadoFrontend = "Rechazado";
                }

                const coincideEstado = filtrosActivos.estados.length === 0 ||
                                     filtrosActivos.estados.includes(estadoFrontend);

                return coincideTipo && coincideEstado;
            });

            return permisosFiltrados;
        }

        // Función para renderizar permisos
        function renderPermissions(data) {
            if (data.length === 0) {
                permissionsContainer.innerHTML = `
                    <div class="no-results">
                        <i class="bi bi-inbox display-1 d-block mb-3"></i>
                        <h3 class="h4 text-muted">No se encontraron permisos</h3>
                        <p class="text-muted">Intenta ajustar los filtros para ver más resultados.</p>
                    </div>
                `;
                return;
            }

            permissionsContainer.innerHTML = data.map(permission => `
                <div class="card permission-card mb-3">
                    <div class="card-body">
                        <div class="mb-2">
                            <div class="d-flex align-items-start gap-1 mb-2 flex-wrap">
                                <h3 class="h6 fw-bold text-dark mb-0">${permission.nombreEmpleado}</h3>
                            </div>
                            <div class="d-flex gap-1 flex-wrap mb-2">
                                <span class="badge custom-badge ${
                                    permission.estado === "Creada" || permission.estado === "Aprobada"
                                        ? "bg-success"
                                        : permission.estado === "Pendiente"
                                            ? "bg-warning"
                                            : permission.estado === "Rechazada"
                                                ? "bg-danger"
                                                : "bg-secondary"
                                }">
                                    ${permission.estado}
                                </span>
                                <span class="badge custom-badge bg-info">${permission.tipo}</span>

                                <div class="row small">
                                    <div class="col-6">
                                        <span class="text-muted fw-semibold">Creación:</span>
                                        <span class="text-dark fw-medium ms-1">${new Date(permission.fechaIngreso).toLocaleDateString('es-CR')}</span>
                                    </div>
                                    <div class="col-6">
                                        <span class="text-muted fw-semibold">Inicio:</span>
                                        <span class="text-dark fw-medium ms-1">${new Date(permission.fechaInicio).toLocaleDateString('es-CR')}</span>
                                    </div>
                                    <div class="col-6">
                                        <span class="text-muted fw-semibold">Fin:</span>
                                        <span class="text-dark fw-medium ms-1">${new Date(permission.fechaFinalizacion).toLocaleDateString('es-CR')}</span>
                                    </div>
                                    <div class="col-6">
                                        <span class="text-muted fw-semibold">Regreso:</span>
                                        <span class="text-dark fw-medium ms-1">${new Date(permission.fechaRegresoLaboral).toLocaleDateString('es-CR')}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="pt-2 border-top">
                            <div class="row small">
                                <div class="col-6">
                                    <span class="text-muted fw-semibold">Motivo:</span>
                                    <span class="text-dark fw-medium ms-1">${permission.motivo}</span>
                                </div>                                
                                <div class="col-6" style="padding-left: 0px">
                                    <span class="text-muted fw-semibold">Comentarios:</span>
                                    <span class="text-dark fw-medium ms-1">${permission.comentarios}</span>
                                </div>
                            </div>
                        </div>

                        ${permission.attachment ? `
                            <div class="mt-2 pt-2 border-top">
                                <div class="d-flex align-items-center gap-1 small">
                                    <i class="bi bi-download text-primary"></i>
                                    <a href="${permission.attachment}" class="text-primary text-decoration-none fw-medium" target="_blank">
                                        Descargar adjunto
                                    </a>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function renderPagination() {
            pagination.innerHTML = '';
            for (let i = 1; i <= totalPaginas; i++) {
                pagination.innerHTML += `
                    <li class="page-item ${i === paginaActual ? 'active' : ''}">
                        <a class="page-link" href="?page=${i}">${i}</a>
                    </li>
                `;
            }
        }

        // Event listeners para filtros
        document.querySelectorAll('.filter-type').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    filtrosActivos.tipos.push(this.value);
                } else {
                    filtrosActivos.tipos = filtrosActivos.tipos.filter(tipo => tipo !== this.value);
                }
                const permisosFiltrados = filtrarPermisos();
                renderPermissions(permisosFiltrados);
            });
        });

        document.querySelectorAll('.filter-status').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    filtrosActivos.estados.push(this.value);
                } else {
                    filtrosActivos.estados = filtrosActivos.estados.filter(estado => estado !== this.value);
                }
                const permisosFiltrados = filtrarPermisos();
                renderPermissions(permisosFiltrados);
            });
        });

        // Limpiar filtros
        document.getElementById('clear-filters').addEventListener('click', function() {
            // Desmarcar todos los checkboxes
            document.querySelectorAll('.filter-type, .filter-status').forEach(checkbox => {
                checkbox.checked = false;
            });

            // Limpiar filtros activos
            filtrosActivos.tipos = [];
            filtrosActivos.estados = [];

            // Renderizar todos los permisos
            renderPermissions(permisos);
        });

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            inicializarContadores();
            renderPermissions(permisos);
            renderPagination();
        });
    </script>
</body>
</html>