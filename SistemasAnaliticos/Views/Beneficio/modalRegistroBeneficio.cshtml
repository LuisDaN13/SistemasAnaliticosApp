@model SistemasAnaliticos.Entidades.Beneficio

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }

        .modal-header {
            background: linear-gradient(to right, #012473, #013599);
            color: white;
        }

        .btn-primary-custom {
            background-color: #012473;
            border-color: #012473;
        }

            .btn-primary-custom:hover {
                background-color: #013599;
                border-color: #013599;
            }

        .section-divider {
            border-top: 1px solid #dee2e6;
            padding-top: 1.25rem;
        }

        .is-invalid {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
        }

        .alert {
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .required-field::after {
            content: " *";
            color: #dc3545;
        }

        .form-label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #495057;
        }
    </style>
</head>
<body>
    <!-- Modal -->
    <div class="modal fade" id="createBeneficioModal" tabindex="-1" aria-labelledby="createBeneficioModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <!-- Header -->
                <div class="modal-header">
                    <h5 class="modal-title fw-bold" id="permissionModalLabel">Nueva Solicitud de Beneficio <span id="tipoDisplay"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <!-- Form -->
                <form id="benForm" asp-controller="Beneficio" asp-action="Create" method="post" enctype="multipart/form-data">
                    <input type="hidden" asp-for="tipo" id="tipoBeneficio" value="" />


                    <div class="modal-body">
                        <!-- Contenedor para mensajes de validación -->
                        <div id="validationAlertsBene"></div>

                        <div>
                            <!-- Motivo -->
                            <div class="mb-3">
                                <label class="form-label required-field">Monto de la Solicitud de Beneficio</label>
                                <input type="number"
                                       asp-for="monto"
                                       id="montoBeneficiario"
                                       class="form-control"
                                       placeholder="Ingrese el monto deseado"
                                       required>
                            </div>

                            <!-- Notas -->
                            <div class="mb-3">
                                <label class="form-label">Comentarios</label>
                                <textarea class="form-control"
                                          asp-for="Comentarios"
                                          rows="2"
                                          placeholder="Información adicional..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="modal-footer bg-light">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary-custom text-white" id="submitBtnBene">
                            <i class="bi bi-save me-2"></i>Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Pasar palabra de tipo -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const modalBeneficio = document.getElementById('createBeneficioModal');

            if (modalBeneficio) {
                modalBeneficio.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget;
                    const tipo = button.getAttribute('data-tipo');

                    // PARA MOSTRAR EN EL TÍTULO DEL MODAL
                    const tipoDisplay = document.getElementById('tipoDisplay');
                    if (tipoDisplay) {
                        tipoDisplay.textContent = tipo;
                    }

                    // PARA GUARDAR EN LA VARIABLE DEL MODEL
                    const tipoBeneficio = document.getElementById('tipoBeneficio');
                    if (tipoBeneficio) {
                        tipoBeneficio.value = tipo;
                    }
                });
            }
        });
    </script>

    <!-- JavaScript para la funcionalidad -->
    <script>
        // SISTEMA DE VALIDACIÓN ESPECÍFICO
        document.addEventListener('DOMContentLoaded', function() {
            inicializarValidacionBene();
            inicializarResetBene();
        });

        function inicializarResetBene() {
            const modal = document.getElementById('createBeneficioModal');
            const form = document.getElementById('benForm');
            const cancelBtn = modal.querySelector('.btn-outline-secondary');

            // Resetear cuando el modal se cierra
            modal.addEventListener('hidden.bs.modal', resetearFormularioBene);

            // Resetear cuando se hace clic en Cancelar
            if (cancelBtn) {
                cancelBtn.addEventListener('click', resetearFormularioBene);
            }
        }

        function resetearFormularioBene() {
            const form = document.getElementById('benForm');
            const modal = document.getElementById('createBeneficioModal');

            // 1. Resetear valores del formulario
            if (form) {
                form.reset();
            }

            // 2. Limpiar todas las clases de validación
            const campos = modal.querySelectorAll('.form-control, .form-select');
            campos.forEach(campo => {
                campo.classList.remove('is-invalid');
                campo.classList.remove('is-valid');
            });

            // 3. Limpiar mensajes de validación
            hideValidationErrorBene();

            // 4. Opcional: Limpiar el texto del tipo de permiso
            const tipoTexto = document.getElementById('tipoTexto');
            if (tipoTexto) tipoTexto.textContent = '';

            console.log('Formulario de beneficios reseteado');
        }

        function inicializarValidacionBene() {
            const form = document.getElementById('benForm');
            const submitBtn = document.getElementById('submitBtnBene');

            if (!form || !submitBtn) {
                console.error('No se encontró el formulario o el botón de submit');
                return;
            }

            // Prevenir el envío por defecto del formulario
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                e.stopPropagation();

                if (validarFormularioBene()) {
                    // Si todo es válido, enviar el formulario
                    this.submit();
                }
            });

            // También manejar el clic del botón por si acaso
            submitBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();

                if (validarFormularioBene()) {
                    form.submit();
                }
            });

            // Validación en tiempo real para campos requeridos
            const requiredFields = form.querySelectorAll('[required]');
            requiredFields.forEach(field => {
                // Validar al perder el foco
                field.addEventListener('blur', function() {
                    validarCampoIndividualBene(this);
                });

                // Validar al cambiar el valor (para campos numéricos y selects)
                field.addEventListener('input', function() {
                    if (this.value.trim() !== '') {
                        this.classList.remove('is-invalid');
                    }
                });
            });
        }

        function validarFormularioBene() {
            let formularioValido = true;
            const invalidFields = [];

            // Obtener el formulario específico dentro del modal
            const form = document.getElementById('benForm');
            if (!form) {
                console.error('No se encontró el formulario');
                return false;
            }

            // Obtener solo los campos requeridos dentro de este formulario específico
            const requiredFields = form.querySelectorAll('[required]');

            if (requiredFields.length === 0) {
                console.warn('No se encontraron campos con atributo required');
            }

            requiredFields.forEach(field => {
                const value = field.value ? field.value.trim() : '';
                const fieldType = field.type;
                const tagName = field.tagName.toLowerCase();

                field.classList.remove('is-invalid', 'is-valid');

                let fieldValid = true;

                if (tagName === 'select') {
                    fieldValid = field.value !== '' && field.value !== null && field.value !== '0';
                } else if (fieldType === 'number') {
                    // Para campos numéricos, verificar que no esté vacío y sea un número válido
                    fieldValid = value !== '' && !isNaN(value) && parseFloat(value) > 0;
                    // También verificar el atributo min si existe
                    if (field.hasAttribute('min')) {
                        const min = parseFloat(field.getAttribute('min'));
                        fieldValid = fieldValid && parseFloat(value) >= min;
                    }
                } else if (fieldType === 'date') {
                    fieldValid = value !== '';
                } else if (fieldType === 'time') {
                    fieldValid = value !== '';
                } else if (fieldType === 'checkbox' || fieldType === 'radio') {
                    fieldValid = field.checked;
                } else {
                    // Para inputs de texto, textarea, etc.
                    fieldValid = value !== '';
                }

                if (!fieldValid) {
                    formularioValido = false;
                    field.classList.add('is-invalid');
                    invalidFields.push(field);
                } else {
                    field.classList.add('is-valid');
                }
            });

            if (!formularioValido) {
                showValidationErrorBene('Por favor complete todos los campos requeridos (*) antes de enviar el formulario.');

                if (invalidFields.length > 0) {
                    // Enfocar el primer campo inválido
                    setTimeout(() => {
                        invalidFields[0].focus();
                        invalidFields[0].scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        });
                    }, 100);
                }
            } else {
                hideValidationErrorBene();
            }

            return formularioValido;
        }

        function validarCampoIndividualBene(campo) {
            if (!campo.hasAttribute('required')) {
                return true; // Solo validar campos requeridos
            }

            const valor = campo.value ? campo.value.trim() : '';
            const tipo = campo.type;
            const tagName = campo.tagName.toLowerCase();

            let esValido = true;

            if (tagName === 'select') {
                esValido = campo.value !== '' && campo.value !== null && campo.value !== '0';
            } else if (tipo === 'number') {
                esValido = valor !== '' && !isNaN(valor) && parseFloat(valor) > 0;
                if (campo.hasAttribute('min')) {
                    const min = parseFloat(campo.getAttribute('min'));
                    esValido = esValido && parseFloat(valor) >= min;
                }
            } else if (tipo === 'date' || tipo === 'time') {
                esValido = valor !== '';
            } else if (tipo === 'checkbox' || tipo === 'radio') {
                esValido = campo.checked;
            } else {
                esValido = valor !== '';
            }

            campo.classList.remove('is-invalid', 'is-valid');

            if (esValido) {
                campo.classList.add('is-valid');
            } else {
                campo.classList.add('is-invalid');
            }

            return esValido;
        }

        function showValidationErrorBene(mensaje) {
            hideValidationErrorBene();

            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            const validationContainer = document.getElementById('validationAlertsBene');
            if (validationContainer) {
                validationContainer.appendChild(alertDiv);
            }
        }

        function hideValidationErrorBene() {
            const validationContainer = document.getElementById('validationAlertsBene');
            if (validationContainer) {
                validationContainer.innerHTML = '';
            }
        }
    </script>
</body>
</html>